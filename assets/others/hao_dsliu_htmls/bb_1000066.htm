<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：[转] 谈谈对IoGetDeviceObjectPointer的理解</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>[转] 谈谈对IoGetDeviceObjectPointer的理解</h2>
<p align="right">发布时间：2014-2-19 10:37
<br>分类名称：Debug_Crack</p><br>
<FONT face="宋体"  ><FONT color="#333333"  >标 题:</FONT><FONT color="#000000"  > 【原创】谈谈对IoGetDeviceObjectPointer的理解</FONT></FONT><FONT color="#666666"  ><BR><FONT face="宋体"  ><FONT color="#333333"  >作 者:</FONT> <FONT color="#000000"  >combojiang</FONT><BR><FONT color="#333333"  >时 间:</FONT> 2008-04-15,11:31:51<BR><FONT color="#333333"  >链 接:</FONT> http://bbs.pediy.com/showthread.php?t=63140<BR></FONT></FONT><BR><FONT face="宋体"  >昨天看到论坛中有朋友对IoGetDeviceObjectPointer不解。在这里简单谈谈我的理解。<BR><B>通过windbg,我们看看IoGetDeviceObjectPointer。</B><BR>lkd&gt;&nbsp;u&nbsp;IoGetDeviceObjectPointer&nbsp;l&nbsp;100<BR>nt!IoGetDeviceObjectPointer:<BR>8056b782&nbsp;8bff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,edi<BR>8056b784&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp<BR>8056b785&nbsp;8bec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp<BR>8056b787&nbsp;83ec20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp,20h&nbsp;;32字节空间<BR>8056b78a&nbsp;8b4508&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+8]&nbsp;;参数ObjectName<BR>8056b78d&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi<BR>8056b78e&nbsp;57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi<BR>8056b78f&nbsp;6a40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;40h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;ZwOpenFile参数&nbsp;OpenOptions<BR>8056b791&nbsp;33f6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,esi<BR>8056b793&nbsp;8945e8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-18h],eax&nbsp;;ObjectName<BR>8056b796&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;ZwOpenFile参数&nbsp;ShareAccess<BR>8056b797&nbsp;8d45f8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,[ebp-8]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;ZwOpenFile参数&nbsp;IoStatusBlock<BR>8056b79a&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax<BR>8056b79b&nbsp;8d45e0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,[ebp-20h]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;ZwOpenFile参数&nbsp;ObjectAttributes<BR>8056b79e&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax<BR>8056b79f&nbsp;ff750c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp+0Ch]&nbsp;;ZwOpenFile参数&nbsp;DesiredAccess<BR>8056b7a2&nbsp;8d4508&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,[ebp+8]<BR>8056b7a5&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;ZwOpenFile参数&nbsp;FileHandle<BR><BR><BR>8056b7a6&nbsp;c745e018000000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-20h],18h&nbsp;&nbsp;;_Length<BR>8056b7ad&nbsp;8975e4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-1Ch],esi&nbsp;&nbsp;;RootDirectory<BR>8056b7b0&nbsp;c745ec00020000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-14h],200h&nbsp;;Attributes<BR>8056b7b7&nbsp;8975f0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-10h],esi&nbsp;&nbsp;;SecurityDescriptor<BR>8056b7ba&nbsp;8975f4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-0Ch],esi&nbsp;&nbsp;;SecurityQualityOfService<BR><BR>8056b7bd&nbsp;e8de36f9ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;nt!ZwOpenFile&nbsp;(804feea0)<BR><BR>8056b7c2&nbsp;8bf8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,eax&nbsp;&nbsp;&nbsp;<BR>8056b7c4&nbsp;3bfe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;判断返回值&nbsp;STATUS_SUCCESS&nbsp;=&nbsp;0<BR>8056b7c6&nbsp;7c36&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nt!IoGetDeviceObjectPointer+0x7c&nbsp;(8056b7fe)<BR><BR>;调用ZwOpenFile成功后<BR>8056b7c8&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;HandleInformation<BR>8056b7c9&nbsp;8d450c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,[ebp+0Ch]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>8056b7cc&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;Object<BR>8056b7cd&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;AccessMode<BR>8056b7ce&nbsp;ff35d81d5580&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[nt!IoFileObjectType&nbsp;(80551dd8)]&nbsp;;ObjectType<BR>8056b7d4&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;DesiredAccess<BR>8056b7d5&nbsp;ff7508&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp+8]&nbsp;&nbsp;;&nbsp;Handle<BR>8056b7d8&nbsp;e87f530400&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;nt!ObReferenceObjectByHandle&nbsp;(805b0b5c)<BR><BR>8056b7dd&nbsp;8bf8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,eax<BR>8056b7df&nbsp;3bfe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,esi&nbsp;&nbsp;<BR>8056b7e1&nbsp;7c13&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nt!IoGetDeviceObjectPointer+0x74&nbsp;(8056b7f6)&nbsp;;ObReferenceObjectByHandle失败跳转<BR><BR>;ObReferenceObjectByHandle成功后<BR>8056b7e3&nbsp;8b450c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+0Ch]&nbsp;&nbsp;&nbsp;;object<BR>8056b7e6&nbsp;8b4d10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[ebp+10h]&nbsp;&nbsp;&nbsp;;FileObject<BR>8056b7e9&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;IoGetRelatedDeviceObject&nbsp;参数&nbsp;FileObject<BR>8056b7ea&nbsp;8901&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ecx],eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;函数出参数<BR>8056b7ec&nbsp;e8a33ef8ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;nt!IoGetRelatedDeviceObject&nbsp;(804ef694)<BR><BR>8056b7f1&nbsp;8b4d14&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[ebp+14h]&nbsp;;取IoGetRelatedDeviceObject&nbsp;参数DeviceObject<BR>8056b7f4&nbsp;8901&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ecx],eax&nbsp;&nbsp;;IoGetRelatedDeviceObject返回值保存<BR><BR>8056b7f6&nbsp;ff7508&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp+8]&nbsp;&nbsp;&nbsp;<BR>8056b7f9&nbsp;e8862ff9ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;nt!ZwClose&nbsp;(804fe784)<BR><BR>8056b7fe&nbsp;8bc7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,edi&nbsp;&nbsp;&nbsp;;ZwOpenFile失败<BR>8056b800&nbsp;5f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi<BR>8056b801&nbsp;5e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi<BR>8056b802&nbsp;c9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leave<BR>8056b803&nbsp;c21000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;10h<BR><BR>由于汇编中可以直接用函数参数作为栈变量来进行读写，而C中不允许，因此我们自己额外定义几个栈变量。<BR><BR><B>逆向为c的代码：</B><BR>NTSTATUS<BR>IoGetDeviceObjectPointer(<BR>&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;PUNICODE_STRING&nbsp;ObjectName,<BR>&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;ACCESS_MASK&nbsp;DesiredAccess,<BR>&nbsp;&nbsp;&nbsp;&nbsp;OUT&nbsp;PFILE_OBJECT&nbsp;*FileObject,<BR>&nbsp;&nbsp;&nbsp;&nbsp;OUT&nbsp;PDEVICE_OBJECT&nbsp;*DeviceObject<BR>&nbsp;&nbsp;&nbsp;&nbsp;)<BR>{<BR>&nbsp;&nbsp;&nbsp;&nbsp;IO_STATUS_BLOCK&nbsp;ioStatus;<BR>&nbsp;&nbsp;&nbsp;&nbsp;OBJECT_ATTRIBUTES&nbsp;objectAttributes;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;//额外定义出来的栈变量。由于C与汇编的游戏规则不同。<BR>&nbsp;&nbsp;&nbsp;&nbsp;PFILE_OBJECT&nbsp;fileObject;<BR>&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;fileHandle;<BR>&nbsp;&nbsp;&nbsp;&nbsp;NTSTATUS&nbsp;status;<BR>&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;InitializeObjectAttributes(&nbsp;&amp;objectAttributes,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ObjectName,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OBJ_KERNEL_HANDLE,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(HANDLE)&nbsp;NULL,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(PSECURITY_DESCRIPTOR)&nbsp;NULL&nbsp;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;ZwOpenFile(&nbsp;&amp;fileHandle,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DesiredAccess,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;objectAttributes,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;ioStatus,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x40&nbsp;);<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(status&nbsp;&gt;=&nbsp;0)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;{<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;status&nbsp;=&nbsp;ObReferenceObjectByHandle(&nbsp;fileHandle,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IoFileObjectType,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(PVOID&nbsp;*)&nbsp;&amp;fileObject,<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(status&nbsp;&gt;=&nbsp;0)&nbsp;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*FileObject&nbsp;=&nbsp;fileObject;<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*DeviceObject&nbsp;=&nbsp;IoGetRelatedDeviceObject(&nbsp;fileObject&nbsp;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ZwClose(&nbsp;fileHandle&nbsp;);<BR>&nbsp;&nbsp;&nbsp;&nbsp;}<BR><BR>&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;status;<BR>}<BR><B>分析：</B><BR><BR>&nbsp;1。&nbsp;&nbsp;IoGetDeviceObjectPointer函数中&nbsp;ObReferenceObjectByHandle增加了其所对应的文件对象的引用，因此该函数调用后，调用ObDereferenceObject减小引用计数。&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<BR>&nbsp;2。&nbsp;&nbsp;IoGetDeviceObjectPointer函数中IoGetRelatedDeviceObject的调用是里面的重点。&nbsp;看IoGetRelatedDeviceObject的说明，就能理解这个函数参数3，参数4的关系。<BR>&nbsp;<BR>&nbsp;<BR><B>IoGetRelatedDeviceObject</B><BR><BR>Given&nbsp;a&nbsp;file&nbsp;object,&nbsp;the&nbsp;IoGetRelatedDeviceObject&nbsp;routine&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;corresponding&nbsp;device&nbsp;object.<BR><BR>PDEVICE_OBJECT&nbsp;<BR>&nbsp;&nbsp;IoGetRelatedDeviceObject(<BR>&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;PFILE_OBJECT&nbsp;&nbsp;FileObject<BR>&nbsp;&nbsp;&nbsp;&nbsp;);<BR><BR>Parameters<BR><BR>FileObject<BR>&nbsp;&nbsp;&nbsp;&nbsp;Pointer&nbsp;to&nbsp;the&nbsp;file&nbsp;object.&nbsp;<BR><BR>Return&nbsp;Value<BR><BR>IoGetRelatedDeviceObject&nbsp;returns&nbsp;a&nbsp;pointer&nbsp;to&nbsp;the&nbsp;device&nbsp;object.<BR>Headers<BR><BR>Declared&nbsp;in&nbsp;wdm.h&nbsp;and&nbsp;ntddk.h.&nbsp;Include&nbsp;wdm.h&nbsp;or&nbsp;ntddk.h.<BR>Comments<BR><BR>When&nbsp;called&nbsp;on&nbsp;a&nbsp;file&nbsp;object&nbsp;that&nbsp;represents&nbsp;the&nbsp;underlying&nbsp;storage&nbsp;device,&nbsp;IoGetRelatedDeviceObject&nbsp;returns&nbsp;the&nbsp;highest-level&nbsp;device&nbsp;object&nbsp;in&nbsp;the&nbsp;storage&nbsp;device&nbsp;stack.&nbsp;To&nbsp;obtain&nbsp;the&nbsp;highest-level&nbsp;device&nbsp;object&nbsp;in&nbsp;the&nbsp;file&nbsp;system&nbsp;driver&nbsp;stack,&nbsp;drivers&nbsp;must&nbsp;call&nbsp;IoGetRelatedDeviceObject&nbsp;on&nbsp;a&nbsp;file&nbsp;object&nbsp;that&nbsp;represents&nbsp;the&nbsp;file&nbsp;system's&nbsp;driver&nbsp;stack,&nbsp;and&nbsp;the&nbsp;file&nbsp;system&nbsp;must&nbsp;currently&nbsp;be&nbsp;mounted.&nbsp;(Otherwise,&nbsp;the&nbsp;storage&nbsp;device&nbsp;stack&nbsp;is&nbsp;traversed&nbsp;instead&nbsp;of&nbsp;the&nbsp;file&nbsp;system&nbsp;stack.)<BR><BR>To&nbsp;ensure&nbsp;that&nbsp;the&nbsp;file&nbsp;system&nbsp;is&nbsp;mounted&nbsp;on&nbsp;the&nbsp;storage&nbsp;device,&nbsp;the&nbsp;driver&nbsp;must&nbsp;have&nbsp;specified&nbsp;an&nbsp;appropriate&nbsp;access&nbsp;mask,&nbsp;such&nbsp;as&nbsp;FILE_READ_DATA&nbsp;or&nbsp;FILE_WRITE_ATTRIBUTES,&nbsp;when&nbsp;opening&nbsp;the&nbsp;file&nbsp;or&nbsp;device&nbsp;represented&nbsp;by&nbsp;the&nbsp;file&nbsp;object.&nbsp;Specifying&nbsp;FILE_READ_ATTRIBUTES&nbsp;does&nbsp;not&nbsp;cause&nbsp;the&nbsp;file&nbsp;system&nbsp;to&nbsp;be&nbsp;mounted.<BR><BR>The&nbsp;caller&nbsp;must&nbsp;be&nbsp;running&nbsp;at&nbsp;IRQL&nbsp;&lt;=&nbsp;DISPATCH_LEVEL.&nbsp;Usually,&nbsp;callers&nbsp;of&nbsp;this&nbsp;routine&nbsp;are&nbsp;running&nbsp;at&nbsp;IRQL&nbsp;=&nbsp;PASSIVE_LEVEL. <BR></FONT><WBR>
</body></html>