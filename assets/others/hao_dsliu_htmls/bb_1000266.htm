<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：Compiling The npruntime Sample Plugin in Visual Studio</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>Compiling The npruntime Sample Plugin in Visual Studio</h2>
<p align="right">发布时间：2011-2-11 13:23
<br>分类名称：Plugins</p><br>
<span style="color: rgb(51, 51, 51); font-family: 'Lucida Grande', 'Lucida Sans Unicode', Lucida, Arial, Helvetica, sans-serif;"  ><div id="section_1"  ><h2 style="margin-top: 0px; margin-right: 0px; margin-bottom: 0.8em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-size: 1.571em; font-family: Georgia, Times, 'Times New Roman', serif; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(224, 224, 220);"  >General decisions</h2><ul style="margin-top: 0px; margin-right: 0px; margin-bottom: 1.286em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 22px; list-style-type: disc; list-style-position: initial; list-style-image: initial;"  ><li>filename of DLL<br>must start with "np" (not "ns") and ends with ".dll" (I wasted hours on this - repeatedly)</li><li>mimetype<br>reflects the data type handled by the plugin. this is how webpages invoke your plugin. should either be like "application/x-vnd-yourorganization-yourfiletype" or be officially registered with IANA (unlikely) or be a standard type (e.g. if you want to play MPEG files).</li><li>file extension<br>reflects the data type handled by the plugin, esp. when loaded from local disk on Windows.</li></ul></div><div id="section_2"  ><span id="Build"  ></span><h2 style="margin-top: 0px; margin-right: 0px; margin-bottom: 0.8em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-size: 1.571em; font-family: Georgia, Times, 'Times New Roman', serif; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(224, 224, 220);"  >Build</h2><ol style="margin-top: 0px; margin-right: 0px; margin-bottom: 1.286em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 22px;"  ><li>Create a new project in Visual Studio for a&nbsp;<strong>Win32 GUI library</strong>&nbsp;(DLL) (in .NET 2003:&nbsp;<strong>Win32</strong>&nbsp;template, then switch to&nbsp;<strong>DLL</strong>&nbsp;in&nbsp;<strong>Application Settings</strong>&nbsp;in the following dialog, export symbols too?)(in Visual Studio 2008, it is&nbsp;<strong>Visualc++|Win32|Win32 Project</strong>, then check&nbsp;<strong>DLL</strong>&nbsp;in the wizard).</li><li>If a wizard gives you a checkbox to create an&nbsp;<strong>empty project</strong>, then check it. Otherwise you'll delete files later.</li><li>Again note that the resulting DLL filename must start with "<strong>np</strong>", so either call your project like this or rename the file later</li><li>Delete the&nbsp;<strong>.cpp</strong>&nbsp;and&nbsp;<strong>.h</strong>&nbsp;and&nbsp;<strong>ReadMe</strong>&nbsp;files from the project and disk (if you did not create an empty project)</li><li>Copy the npruntime sample plugin source code into the dir of the new VS project and add the files to the project using the VS GUI (<strong>.cpp</strong>&nbsp;files to "Source Files",&nbsp;<strong>.h</strong>&nbsp;files to "Header Files",&nbsp;<strong>.rc</strong>&nbsp;file to "Resource Files"). Samples can be obtained from:<a style="color: rgb(51, 102, 153); text-decoration: none; padding-right: 16px; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: transparent; background-position: 99% 40%; background-repeat: no-repeat no-repeat;" rel="nofollow" href="https://developer.mozilla.org/en/Plugins/Samples_and_Test_Cases"  >https://developer.mozilla.org/en/Plugins/Samples_and_Test_Cases</a></li><li>Download the&nbsp;<strong>Gecko SDK</strong>&nbsp;(aka XULRunner SDK) from mozilla.org release FTP and extract it. You can download it from here:<a title="http://developer.mozilla.org/en/docs/Gecko_SDK" style="color: rgb(51, 102, 153); text-decoration: none; padding-right: 16px; background-attachment: initial; background-origin: initial; background-clip: initial; background-color: transparent; background-position: 99% 40%; background-repeat: no-repeat no-repeat;" target="_blank" rel="nofollow" href="http://developer.mozilla.org/en/docs/Gecko_SDK"  >http://developer.mozilla.org/en/docs/Gecko_SDK</a></li><li>Add the&nbsp;<strong>Gecko SDK include path</strong>&nbsp;(example&nbsp;: C:\xulrunner-sdk\sdk\include) to&nbsp;<strong>Project Properties|(all configurations)|C++|General|Additional Include Directories</strong>. Note: If your project is still empty, the C++&nbsp;tree might not be visible. So, add some files first.</li><li>Add the following preprocessor definitions to&nbsp;<strong>Project Properties|(all configurations)|C++|Preprocessor|Preprocessor Definitions:</strong><strong><code style="font-style: inherit; font-weight: inherit; font: normal normal normal 100%/normal 'Courier New', 'Andale Mono', monospace;"  >WIN32;_WINDOWS;XP_WIN32;MOZILLA_STRICT_API;XPCOM_GLUE;XP_WIN;_X86_;NPSIMPLE_EXPORTS</code></strong></li><li>Disable precompiled headers using&nbsp;<strong>Project Properties|(all configurations)|C++|Precompiled headers|Create/Use precompiled header</strong>. They may be already disabled.</li><li>Define the function exports by adding the&nbsp;<strong>.def</strong>&nbsp;filename (e.g. nprt.def) to&nbsp;<strong>Project Properties|(all configurations)|Linker|Input|Module Definition File</strong>. It could be either the full path or the path relative to the project directory.</li><li>Optional: Open the above&nbsp;<strong>.def</strong>&nbsp;file and change "NPRT" to the filename of your dll as VS sees it (without "np", if you decided to rename later)</li><li>Optional: Edit the&nbsp;<strong>.rc</strong>&nbsp;file and and the top of&nbsp;<strong>npp_gate.cpp</strong>&nbsp;for the description, mimetype, file extension etc. to reflect your plugin</li><li>Remove the function&nbsp;<strong><code style="font-style: inherit; font-weight: inherit; font: normal normal normal 100%/normal 'Courier New', 'Andale Mono', monospace;"  >NPP_GetJavaClass</code></strong>&nbsp;from&nbsp;<strong>npp_gate.cpp</strong></li><li>Build</li><li>Rename the resulting DLL so that the filename starts with "<strong>np</strong>" and ends with ".dll" (or "32.dll"? 8.3?) and copy it in Mozilla's "plugins" folder</li><li>Start Mozilla and open&nbsp;<strong>about:plugins</strong>&nbsp;to verify the plugin is detected</li><li>Open the file "test.html" and begin testing. Make sure the mimetypes of your html embed tags match the mimetype specified in your&nbsp;<strong>nprt.rc</strong>file and the top of your&nbsp;<strong>npp_gate.cpp</strong>&nbsp;file</li></ol></div><div id="section_3"  ><span id="Version_Issues"  ></span><h2 style="margin-top: 0px; margin-right: 0px; margin-bottom: 0.8em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; font-size: 1.571em; font-family: Georgia, Times, 'Times New Roman', serif; border-bottom-width: 1px; border-bottom-style: solid; border-bottom-color: rgb(224, 224, 220);"  >Version Issues</h2><ol style="margin-top: 0px; margin-right: 0px; margin-bottom: 1.286em; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 22px;"  ><li>If you are using Gecko SDK v1.9 and higher, you'll probably need to add folders&nbsp;<strong>\plugin</strong>,&nbsp;<strong>\nspr</strong>, and&nbsp;<strong>\java</strong>&nbsp;as included directories (as seen above, go to&nbsp;<strong>Project Properties|(all configurations)|C++|General|Additional Include Directories</strong>). These directories are contained in the Gecko SDK include path that you previously added.</li><li>If VC++ compiler throws you&nbsp;<strong><code style="font-style: inherit; font-weight: inherit; font: normal normal normal 100%/normal 'Courier New', 'Andale Mono', monospace;"  >error C2664</code></strong>&nbsp;on 'DrawText' function call, you may replace it by 'DrawTextA'. In fact, all win32 API functions dealing with character strings can be added an 'A' to the end to avoid unicode cast errors.</li><li>Visual C++ 2008 Express don't support C99 standard about&nbsp;<strong>int32_t</strong>,&nbsp;<strong>uint32_t</strong>. You have to add&nbsp;<strong>#include "nptypes.h"</strong>&nbsp;in top of&nbsp;<strong>plugin.h</strong>file. For&nbsp;<strong>xulrunner 1.9.0.1 SDK</strong>, npapi.h file uses&nbsp;<strong>int32</strong>,&nbsp;<strong>uint32&nbsp;</strong>which is different from&nbsp;<strong>int32_t</strong>,&nbsp;<strong>uint32_t&nbsp;</strong>defined in&nbsp;<strong>nptypes.h</strong>, and it may cause problems in link stage.</li><li>For&nbsp;<strong>xulrunner 1.9.0.1 SDK</strong>, you may not find&nbsp;<strong>npfunctions.h</strong>&nbsp;in include directories. You have to replace all&nbsp;<strong>npfunctions.h</strong>&nbsp;by<strong>&nbsp;npnpp.h</strong>&nbsp;in<strong>#include</strong>&nbsp;line.</li><li>Feel free to append here your issues fixes if the above guide helped you.</li></ol></div></span><wbr>
</body></html>