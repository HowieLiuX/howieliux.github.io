<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：[转] Iphone 推送功能</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>[转] Iphone 推送功能</h2>
<p align="right">发布时间：2010-2-23 13:20
<br>分类名称：Mac</p><br>
<p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >QQ</span><span style="font-family: 宋体; font-size: 12pt;"   >发布了<span lang="EN-US"   >3.3.0</span>，主要增加了对<span lang="EN-US"   >iPhone Push</span>功能的支持。但是，由于<span lang="EN-US"   >blacksn0w</span>解锁软件的缺陷，用其解锁激活的<span lang="EN-US"   >iPhone</span>无不出现了<span lang="EN-US"   >Push</span>的缺陷。鉴于国内许多人对<span lang="EN-US"   >iPhone</span>的<span lang="EN-US"   >Push</span>功能的误解，并导致很多匪夷所思的言论，晓晓决定写一篇文章，对<span lang="EN-US"   >iPhone</span>的<span lang="EN-US"   >Push</span>功能，进行一次科普，顺便为各位分析下目前存在的几种补丁的原理。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; color: red; font-size: 12pt;"   >敬告小白：本文理论内容来自<span lang="EN-US"   >iPhone</span>官方参考文件，涉及破解的内容来自<span lang="EN-US"   >dev team</span>和<span lang="EN-US"   >ih8sn0w</span>。如果你认为你对<span lang="EN-US"   >iPhone</span>的理解比<span lang="EN-US"   >Apple</span>还要正确，请直接向<span lang="EN-US"   >Apple</span>指出文档中的错误之处。本人无责任翻译概括。</span></b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ><br><br></span><b><span style="font-family: 宋体; font-size: 12pt;"   >注意：<span lang="EN-US"   >blackra1n</span>越狱本身并不会导致不能<span lang="EN-US"   >Push</span>的缺陷，导致缺陷的是用于解锁的<span lang="EN-US"   >blacksn0w</span>。如果你想争论，请先阅读完本篇文章，再自己好好想想。</span></b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 18pt;"   ><font size="3"   >第一部分：<span lang="EN-US"   >Push</span>原理<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >(</span><span style="font-family: 宋体; font-size: 12pt;"   >以下绝大多数内容参考自、图片来自<span lang="EN-US"   >iPhone OS Reference Library)</span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 13.5pt;"   ><font size="3"   >机制简介<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >Push</span><span style="font-family: 宋体; font-size: 12pt;"   >的工作机制可以简单的概括为下图<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   ></span> <a target="_blank" href="pic/img.ph.126.net_Lfk6F4qmKrNxXym70NHU6w==_3266517104727728217.jpg"   ><img title="[转] Iphone 推送功能 - Dsliu - Dspace"   alt="[转] Iphone 推送功能 - Dsliu - Dspace"   src="pic/img.ph.126.net_Lfk6F4qmKrNxXym70NHU6w==_3266517104727728217.jpg"   ></a></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >图中，<span lang="EN-US"   ></span></span></p> <ul type="disc"   > <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >Provider</span><span style="font-family: 宋体; font-size: 12pt;"   >是指某个<span lang="EN-US"   >iPhone</span>软件的<span lang="EN-US"   >Push</span>服务器。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >APNS</span></b><b><span style="font-family: 宋体; font-size: 12pt;"   >是<span lang="EN-US"   >Apple Push Notification Service</span>（<span lang="EN-US"   >Apple Push</span>服务器）的缩写，下文统一使用该缩写。</span></b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></li></ul> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >因此，整个过程可以分为三个阶段，下面用大家常用的聊天客户端<span lang="EN-US"   >BeejiveIM</span>来说明。（<span lang="EN-US"   >BeejiveIM</span>是一款支持多账户登录的支持<span lang="EN-US"   >Push</span>的<span lang="EN-US"   >iPhone</span>聊天客户端，支持<span lang="EN-US"   >MSN</span>、<span lang="EN-US"   >Google Talk</span>等）<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >此时<span lang="EN-US"   >Provider</span>为<span lang="EN-US"   >BeejiveIM</span>服务器，<b>我们在<span lang="EN-US"   >BeejiveIM</span>上登陆<span lang="EN-US"   >MSN,</span>其实软件是先把登录信息发送到<span lang="EN-US"   >BeejiveIM</span>服务器，再通过其服务器来登陆<span lang="EN-US"   >MSN</span></b>。因此，当我关闭了<span lang="EN-US"   >BeejiveIM</span>，<span lang="EN-US"   >BeejiveIM</span>服务器会继续为我登陆<span lang="EN-US"   >MSN</span>，此时如果有人对我的<span lang="EN-US"   >MSN</span>账户发送了消息，那么就会触发<span lang="EN-US"   >Push</span>。此时：<span lang="EN-US"   ></span></span></p> <ul type="disc"   > <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >第一阶段：<span lang="EN-US"   >BeejiveIM</span>服务器把要发送的消息、目的<span lang="EN-US"   >iPhone</span>的标识打包，发给<span lang="EN-US"   >APNS</span>。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >第二阶段：<span lang="EN-US"   >APNS</span>在自身的已注册<span lang="EN-US"   >Push</span>服务的<span lang="EN-US"   >iPhone</span>列表中，查找有相应标识的<span lang="EN-US"   >iPhone</span>，并把消息发到<span lang="EN-US"   >iPhone</span>。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >第三阶段：<span lang="EN-US"   >iPhone</span>把发来的消息传递给相应的应用程序，并且按照设定弹出<span lang="EN-US"   >Push</span>通知。<span lang="EN-US"   ></span></span></li></ul> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><font size="3"   ><b><span style="font-family: 宋体; font-size: 13.5pt;"   lang="EN-US"   >Push</span></b><b><span style="font-family: 宋体; font-size: 13.5pt;"   >认证<span lang="EN-US"   ></span></span></b></font></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >许多朋友说<span lang="EN-US"   >Push</span>不能用。其中一大部分，就是在认证阶段就出了问题。想了解原因？请细看：<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >这里所说的认证机制，实际上包含两层。一层是<b>物理连接上的认证</b>，另一层则才是涉及到<b><span lang="EN-US"   >iPhone</span>设备令牌的认证。</b><span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 12pt;"   >物理连接上的认证：<span lang="EN-US"   >SSL/TLS</span>链接</span></b></p><p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><a target="_blank" href="pic/img116.ph.126.net_gtdUd0oPyo7Cr4M1KQYzgQ==_715790865776979939.jpg"   ><img title="[转] Iphone 推送功能 - Dsliu - Dspace"   alt="[转] Iphone 推送功能 - Dsliu - Dspace"   src="pic/img116.ph.126.net_gtdUd0oPyo7Cr4M1KQYzgQ==_715790865776979939.jpg"   ></a><br><b><span style="font-family: 宋体; font-size: 12pt;"   ><span lang="EN-US"   ></span></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >（如果你了解<span lang="EN-US"   >TLS</span>，那么这里我几乎无需介绍。）<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >iPhone</span><span style="font-family: 宋体; font-size: 12pt;"   >在开启<span lang="EN-US"   >Push</span>的时候，会连接<span lang="EN-US"   >APNS</span>建立一条<span lang="EN-US"   >TLS</span>加密链接。每一台正常的<span lang="EN-US"   >iPhone</span>都有一个独有的设备证书，而<span lang="EN-US"   >APNS</span>也有一个服务器证书。两者建立的时候，会验证彼此的证书有效性。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >TLS</span></b><b><span style="font-family: 宋体; font-size: 12pt;"   >链接一旦建立，在没有数据的情况下，只需要每隔<span lang="EN-US"   >15</span>分钟进行一次保活的握手，因此几乎不占流量。</span></b><span style="font-family: 宋体; font-size: 12pt;"   >而一旦因为意外原因导致链接中断，<span lang="EN-US"   >iPhone</span>会不断重新尝试建立<span lang="EN-US"   >TLS</span>链接，直到成功。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 12pt;"   >更高一层次：基于<span lang="EN-US"   >token(</span>令牌<span lang="EN-US"   >)</span>的认证<span lang="EN-US"   ></span></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >在机制简介里，我提到过<b><span lang="EN-US"   >APNS</span>判断<span lang="EN-US"   >Push</span>推送消息该发给哪台<span lang="EN-US"   >iPhone</span>的依据</b>是一个“目的<span lang="EN-US"   >iPhone</span>的标识”，这个标识就是<b><span lang="EN-US"   >device token(</span>设备令牌<span lang="EN-US"   >)</span></b>。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; color: red; font-size: 12pt;"   >设备令牌是怎么生成的呢？是每次建立<span lang="EN-US"   >TLS</span>连接时，<span lang="EN-US"   >APNS</span>通过前一层次<span lang="EN-US"   >(TLS</span>层<span lang="EN-US"   >)</span>里我们提到的每台正常的<span lang="EN-US"   >iPhone</span>唯一的设备证书<span lang="EN-US"   >(unique device certificate)</span>，并用令牌密钥<span lang="EN-US"   >(token key)</span>加密生成的。</span></b></p><p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><a target="_blank" href="pic/img.ph.126.net__UHXCiNgBbA1UD-ORl8Jzg==_3224577333197834096.jpg"   ><img title="[转] Iphone 推送功能 - Dsliu - Dspace"   alt="[转] Iphone 推送功能 - Dsliu - Dspace"   src="pic/img.ph.126.net__UHXCiNgBbA1UD-ORl8Jzg==_3224577333197834096.jpg"   ></a><br><b><span style="font-family: 宋体; color: red; font-size: 12pt;"   ></span></b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >在令牌生成了之后，<span lang="EN-US"   >APNS</span>会把设备令牌<span lang="EN-US"   >(device token)</span>返回给<span lang="EN-US"   >iPhone</span>，而对应的<span lang="EN-US"   >Push</span>应用程序（如<span lang="EN-US"   >BeejiveIM</span>），则把返回来的设备令牌<span lang="EN-US"   >(device token)</span>直接发送给<span lang="EN-US"   >Provider</span>（如<span lang="EN-US"   >BeejiveIM</span>服务器）。这样，<b>当<span lang="EN-US"   >Provider</span>有<span lang="EN-US"   >Push</span>消息要发送时，就会把对应帐号的设备令牌<span lang="EN-US"   >(device token)</span>和消息一起发送给<span lang="EN-US"   >APNS</span>，而<span lang="EN-US"   >APNS</span>再依据设备令牌<span lang="EN-US"   >(device token)</span>，找到相应<span lang="EN-US"   >TLS</span>链接的<span lang="EN-US"   >iPhone</span>，并发送相应的<span lang="EN-US"   >Push</span>消息</b>。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >以上复杂的流程可以归纳为下面这幅图：</span></p><p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><a target="_blank" href="pic/img616.ph.126.net__ki9J7KNKcO07hTsfJjyzA==_1988620710462502421.jpg"   ><img title="[转] Iphone 推送功能 - Dsliu - Dspace"   alt="[转] Iphone 推送功能 - Dsliu - Dspace"   src="pic/img616.ph.126.net__ki9J7KNKcO07hTsfJjyzA==_1988620710462502421.jpg"   ></a><br><span style="font-family: 宋体; font-size: 12pt;"   ><span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >图中，<span lang="EN-US"   >Client App</span>是<span lang="EN-US"   >iPhone</span>上的<span lang="EN-US"   >Push</span>应用程序。（图中缺了一条（当有<span lang="EN-US"   >Push</span>消息时）由<span lang="EN-US"   >Provider</span>到<span lang="EN-US"   >APNS</span>的链接）<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 12pt;"   >最重要的部分——每台<span lang="EN-US"   >iPhone</span>独有的设备证书和密钥的来历<span lang="EN-US"   ></span></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >正常的<span lang="EN-US"   >iPhone</span>刷系统之后，是没有设备证书和密钥的。这就是为什么<span lang="EN-US"   >iPhone</span>会需要连接到<span lang="EN-US"   >iTunes</span>上进行激活——<b>激活过程中，<span lang="EN-US"   >Apple</span>会分配给每台<span lang="EN-US"   >iPhone</span>独一无二的设备证书<span lang="EN-US"   >(device certificate)</span>和密钥<span lang="EN-US"   >(key)</span></b>。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><i><span style="font-family: 宋体; font-size: 12pt;"   >以上我仅仅介绍了从<span lang="EN-US"   >iPhone</span>到<span lang="EN-US"   >APNS</span>的链接建立。其实从<span lang="EN-US"   >Provider</span>到<span lang="EN-US"   >APNS</span>也有一条<span lang="EN-US"   >TLS</span>链接，但是与本文关系不大，所以不多加介绍了。</span></i><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 18pt;"   ><font size="3"   >我的<span lang="EN-US"   >PUSH</span>问题出在哪里？<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >相信许多同学都抱有这样的疑问。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >正如上文提到的，<span lang="EN-US"   >iPhone</span>的<span lang="EN-US"   >Push</span>需要<span lang="EN-US"   >APNS</span>生成对应<span lang="EN-US"   >iPhone</span>的设备令牌，但生成这个令牌又需要<span lang="EN-US"   >iPhone</span>上的有效的设备证书<span lang="EN-US"   >(device certificate)</span>和密钥<span lang="EN-US"   >(key)</span>，但是：<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >iPhone OS 3.X </span><span style="font-family: 宋体; font-size: 12pt;"   >使用<span lang="EN-US"   >blacksn0w</span>进行<b>解锁</b>的过程，是不经过<span lang="EN-US"   >iTunes</span>的，而<b><span lang="EN-US"   >blacksn0w</span>本身又不生成对应的设备证书<span lang="EN-US"   >(device certificate)</span>和密钥<span lang="EN-US"   >(key)</span></b>，因此这样解锁完的<span lang="EN-US"   >iPhone</span>根本不可能与<span lang="EN-US"   >APNS</span>建立任何的<span lang="EN-US"   >TLS</span>链接，<span lang="EN-US"   >Push</span>自然废了。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 13.5pt;"   ><font size="3"   >有关各种<span lang="EN-US"   >pushfix</span>补丁<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >要修补这个问题，唯一的办法就是<b>重新生成唯一且有效的设备证书<span lang="EN-US"   >(device certificate)</span>和密钥<span lang="EN-US"   >(key)</span></b>。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >但是要知道，证书是需要机构签发的，自己一个人随便弄的一个证书，只会被<span lang="EN-US"   >APNS</span>认为是无效证书。（<span lang="EN-US"   >SSL</span>证书一个多少钱大家可以去查查）<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >并且对应的文件似乎还和<span lang="EN-US"   >iPhone</span>本机的一些内容相关，不是直接制作好的文件放进去就可以的。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >于是，最早，<span lang="EN-US"   >dev team</span>推出了一个测试版补丁，<span lang="EN-US"   >Push fix by dev team</span>（通过他们的<span lang="EN-US"   >twitter</span>发布的，因此官网没有消息）。这个补丁初期很有效。但是仅在<span lang="EN-US"   >iPhone 2G</span>上比较正常。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >之后某人士发布<span lang="EN-US"   >pushfix 1.0</span>了。由于使用了不同的生成方法，因此在新版本<span lang="EN-US"   >iPhone</span>上也正常工作了。于是风靡一时。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><s><span style="font-family: 宋体; font-size: 12pt;"   >然而，以上两个补丁都有严重的隐患——他们使用了一个固定的证书作为设备证书<span lang="EN-US"   >(device certificate)</span>。因此在不同<span lang="EN-US"   >iPhone</span>上的区别仅仅在于生成的密钥<span lang="EN-US"   >(key)</span>不同。</span></s></b><span style="font-family: 宋体; font-size: 12pt;"   >（待确认）<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >上面提到过，<span lang="EN-US"   >APNS</span>依靠每台<span lang="EN-US"   >iPhone</span>独一无二的设备证书<span lang="EN-US"   >(device certificate)</span>和密钥<span lang="EN-US"   >(key)</span>来生成独一无二的设备令牌<span lang="EN-US"   >(device token)</span>，用来标识每台<span lang="EN-US"   >iPhone</span>。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 12pt;"   >但当多个<span lang="EN-US"   >iPhone</span>的设备证书<span lang="EN-US"   >(device certificate)</span>完全一致时，就存在一定几率使得多个<span lang="EN-US"   >iPhone</span>获得相同的设备令牌<span lang="EN-US"   >(device token)</span></span></b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 12pt;"   >而随着这两个补丁的使用人数不断增加，使得出现获得相同设备令牌<span lang="EN-US"   >(device token)</span>的<span lang="EN-US"   >iPhone</span>数量大大增加了。</span></b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; color: red; font-size: 12pt;"   >当这些相同设备令牌<span lang="EN-US"   >(device token)</span>的<span lang="EN-US"   >iPhone</span>上启用了同一个应用程序的<span lang="EN-US"   >Push</span>的时候，就极有可能出现彼此间的<span lang="EN-US"   >Push</span>串发的现象。——如某论坛目前<span lang="EN-US"   >N</span>多人抱怨<span lang="EN-US"   >QQ</span>的<span lang="EN-US"   >Push</span>到别人<span lang="EN-US"   >iPhone</span>上的情况就是如此。</span></b><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >之后，<span lang="EN-US"   >Pushfix</span>的作者，声称自己可以为每台<span lang="EN-US"   >iPhone</span><b>手工制作唯一的设备证书<span lang="EN-US"   >(device certificate)</span>和密钥<span lang="EN-US"   >(key)</span></b>，并且开始提供了付费服务，并且最终推出了付费的<span lang="EN-US"   >Pushfix 2.0</span>——其通过<span lang="EN-US"   >cydia</span>安装的原理是，在安装的时候在线连接到<span lang="EN-US"   >pushfix</span>站点检查对应<span lang="EN-US"   >iPhone</span>的<span lang="EN-US"   >imei</span>确定是否付费再自动下载对应的证书。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >虽然不知道他是怎么制作这些证书的。但是经过晓晓的验证，他制作的证书确实是有效的。<span lang="EN-US"   >Push</span>问题确实修复了。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >在这之后，某论坛上出现了一个叫做<span lang="EN-US"   >Pushfix_D</span>的补丁，声称无需付费也能直接修复问题。然而，<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >——考虑到一些情况，我决定把对<span lang="EN-US"   >Pushfix_D</span>的判断用英文发出来。当然，制作者肯定很清楚下面写的东西：）<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >it contains the same released push keys from back in July 2009. &nbsp;Everybody gets the same key, so it is going to have all the same problems of ALL the free push fixes. &nbsp;Push isn't going to work very long and it is going to drain your battery.</span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 18pt;"   ><font size="3"   >其他出错的情况<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 13.5pt;"   ><font size="3"   >我的<span lang="EN-US"   >iPhone</span>在<span lang="EN-US"   >cmwap</span>下无法<span lang="EN-US"   >push</span>？！<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >对的，这完全正常。在<span lang="EN-US"   >wap</span>网内，<span lang="EN-US"   >TLS</span>链接几乎无法建立成功。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 13.5pt;"   ><font size="3"   >我的<span lang="EN-US"   >iPhone</span>在<span lang="EN-US"   >Wi-Fi</span>下无法<span lang="EN-US"   >push</span>？！<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >实际上这得说是<span lang="EN-US"   >iPhone</span>与某些无线路由器的不兼容。如果无线路由器开启了<b><span lang="EN-US"   >DNS</span>转发功能</b>，那么很有可能你的<span lang="EN-US"   >iPhone</span>无法成功与<span lang="EN-US"   >APNS</span>服务器建立<span lang="EN-US"   >TLS</span>链接。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >解决方法：<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >关闭无线路由器的<span lang="EN-US"   >DNS</span>转发功能，手动为<span lang="EN-US"   >iPhone</span>的<span lang="EN-US"   >Wi-Fi</span>连接设置<span lang="EN-US"   >DNS</span>为<span lang="EN-US"   >8.8.8.8</span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >补充，实际上，这也就是为什么<span lang="EN-US"   >iPhone</span>连接到<span lang="EN-US"   >Wi-Fi</span>上而又不能收到<span lang="EN-US"   >Push</span>的时候，会变得发热且非常耗电。因为<span lang="EN-US"   >iPhone</span>会<b>不断尝试建立<span lang="EN-US"   >TLS</span>链接</b>。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 18pt;"   ><font size="3"   >如何得知我的<span lang="EN-US"   >Push</span>是否破解成功？<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >一个简单的方法就是安装<span lang="EN-US"   > Twitbird Pro</span>版本。在其<span lang="EN-US"   >Accounts</span>页面，会显示当前软件的<span lang="EN-US"   >Push</span>注册状况。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >或者你可以用<span lang="EN-US"   >WinSCP</span>之类的软件查看<span lang="EN-US"   >iPhone</span>上的<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >/var/mobile/Library/Preferences/com.apple.apsd.plist</span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >文件状态。<span lang="EN-US"   ></span></span></p> <ul type="disc"   > <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >如果其大小为<span lang="EN-US"   >119</span>字节，则说明该<span lang="EN-US"   >iPhone</span>已经成功取得了设备令牌<span lang="EN-US"   >(device token)</span>，并保存在该文件中。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >如果小于该大小，则说明该<span lang="EN-US"   >iPhone</span>已经和<span lang="EN-US"   >APNS</span>链接过，但是未能取得设备令牌<span lang="EN-US"   >(device token)</span>。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >如果没有该文件，那说明该<span lang="EN-US"   >iPhone</span>根本没能成功连接到<span lang="EN-US"   >APNS</span>。<span lang="EN-US"   ></span></span></li></ul> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 18pt;"   ><font size="3"   >其他一些值得注意的问题<span lang="EN-US"   ></span></font></span></b></p> <ul type="disc"   > <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >iPod Touch</span><span style="font-family: 宋体; font-size: 12pt;"   >与<span lang="EN-US"   >iPhone</span>的<span lang="EN-US"   >Push</span>机制不完全相同，锁屏后<span lang="EN-US"   >15</span>分钟方检查一次。故请勿与上文对号入座。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   >APNS</span><span style="font-family: 宋体; font-size: 12pt;"   >在发送<span lang="EN-US"   >Push</span>消息时，如果发现对应的<span lang="EN-US"   >iPhone</span>链接中断，则会延后几分钟再发送。超过一个时间后，<span lang="EN-US"   >Push</span>消息会被删除。因此请注意你的网络状况是否影响<span lang="EN-US"   >Push</span>正常工作。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >如上文所说，每台<span lang="EN-US"   >iPhone</span>的设备令牌<span lang="EN-US"   >(device token)</span>储存在<span lang="EN-US"   >/var/mobile/Library/Preferences/com.apple.apsd.plist </span>文件中。这就是为什么每次需要重装<span lang="EN-US"   >Push</span>补丁时，建议删除<span lang="EN-US"   >push</span>程序并删除该文件。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >使用<span lang="EN-US"   >sbsettings</span>的<span lang="EN-US"   >EDGE</span>开关关闭<span lang="EN-US"   >EDGE</span>，却不关闭<span lang="EN-US"   >Push</span>的话，会导致<span lang="EN-US"   >iPhone</span>不断尝试建立<span lang="EN-US"   >TLS</span>连接，最终耗尽电量。因此，如果你不打算或不能用<span lang="EN-US"   >Push</span>，请关闭<span lang="EN-US"   >Push</span>选项。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >对软件的<span lang="EN-US"   >Push</span>服务器<span lang="EN-US"   >(Provider)</span>而言，<span lang="EN-US"   >Wi-Fi</span>与手机网络是一样的，在<span lang="EN-US"   >Push</span>处理上不会有任何区别。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >虽然已经解释的很清楚，但还是明说一句，只要<span lang="EN-US"   >TLS</span>连接正常，<span lang="EN-US"   >Push</span>服务就是实时的，速度仅取决于<span lang="EN-US"   >Provider</span>而已。<span lang="EN-US"   ></span></span></li> <li style="text-align: left; margin: 0cm 0cm 0pt;"   ><span style="font-family: 宋体; font-size: 12pt;"   >题外话，<span lang="EN-US"   >iPhone</span>上的邮件推送为<span lang="EN-US"   >Push Mail</span>技术，与本文所说的<span lang="EN-US"   >Push</span>完全不同。请查阅<span lang="EN-US"   >Exchange Direct Push</span>相关内容。<span lang="EN-US"   ></span></span></li></ul> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><b><span style="font-family: 宋体; font-size: 18pt;"   ><font size="3"   >福利<span lang="EN-US"   ></span></font></span></b></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >一句话，如果你觉得<span lang="EN-US"   >Push</span>没什么用，那只能说明你见识太少。在以下页面可以查看一些支持<span lang="EN-US"   >Push</span>的优秀软件。<span lang="EN-US"   ></span></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   lang="EN-US"   ><a target="_blank" rel="nofollow" href="http://appadvice.com/applists/show/definitive-list-of-push-capable-apps"   ><span style="color: blue;"   >http://appadvice.com/applists/show/definitive-list-of-push-capable-apps</span></a></span></p> <p style="text-align: left; margin: 0cm 0cm 0pt;"   align="left"   ><span style="font-family: 宋体; font-size: 12pt;"   >内容参考：<span lang="EN-US"   ><a target="_blank" rel="nofollow" href="http://developer.apple.com/iphone/library/documentation/NetworkingInternet/Conceptual/RemoteNotificationsPG/ApplePushService/ApplePushService.html"   ><span style="color: blue;"   >iPhone OS Reference Library</span></a></span></span></p> <p style="margin: 0cm 0cm 0pt;"   ><span lang="EN-US"   ><font face="Calibri"   size="3"   >&nbsp;</font></span></p> <p><font size="3"   ></font>&nbsp;</p>
</body></html>