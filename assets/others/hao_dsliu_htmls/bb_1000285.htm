<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：Openssl之BIO系列(3)</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>Openssl之BIO系列(3)</h2>
<p align="right">发布时间：2010-5-28 16:17
<br>分类名称：OpenSSL</p><br>
<h2><span style="font-size: 14px; font-weight: normal; line-height: 22px; color: rgb(63, 63, 63);"><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">17.</span><span style="line-height: 33px; font-family: 黑体;">连接</span><span lang="EN-US" style="line-height: 33px;">(connect)</span><span style="line-height: 33px; font-family: 黑体;">类型</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">封装了</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">Connect</span><span style="line-height: 22px; font-family: 宋体;">方法，它使得编程的时候可以使用统一的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">规则进行</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">connect</span><span style="line-height: 22px; font-family: 宋体;">连接的操作和数据的发送接受，而不用关心具体平台的</span><span lang="EN-US" style="line-height: 22px;">Socket</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">connect</span><span style="line-height: 22px; font-family: 宋体;">方法的区别。其相关定义的一些函数如下</span><span lang="EN-US" style="line-height: 22px;">(openssl\bio.h)</span><span style="line-height: 22px; font-family: 宋体;">：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD * BIO_s_connect(void);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_conn_hostname(b, name) BIO_ctrl(b, BIO_C_SET_CONNECT, 0, (char *) name)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_conn_port(b,port) BIO_ctrl(b,BIO_C_SET_CONNECT,1,(char *)port)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_conn_ip(b,ip) BIO_ctrl(b,BIO_C_SET_CONNECT,2,(char *)ip)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_conn_int_port(b,port) BIO_ctrl(b,BIO_C_SET_CONNECT,3,(char *)port)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_conn_hostname(b) BIO_ptr_ctrl(b,BIO_C_GET_CONNECT,0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_conn_port(b) BIO_ptr_ctrl(b,BIO_C_GET_CONNECT,1)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_conn_ip(b,ip) BIO_ptr_ctrl(b,BIO_C_SET_CONNECT,2)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_conn_int_port(b,port) BIO_int_ctrl(b,BIO_C_SET_CONNECT,3,port)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_nbio(b,n) BIO_ctrl(b,BIO_C_SET_NBIO,(n),NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_do_connect(b) BIO_do_handshake(b)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *BIO_new_connect(char *str)<o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.1 BIO_s_connect<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回一个</span><span lang="EN-US" style="line-height: 22px;">connect</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，该结构定义如下：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">static BIO_METHOD methods_connectp=<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_TYPE_CONNECT,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">"socket connect",<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">conn_write,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">conn_read,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">conn_puts,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* connect_gets, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">conn_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">conn_new,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">conn_free,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">conn_callback_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">};<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">事实上，为了维护一个</span><span lang="EN-US" style="line-height: 22px;">Socket</span><span style="line-height: 22px; font-family: 宋体;">结构，</span><span lang="EN-US" style="line-height: 22px;">openssl</span><span style="line-height: 22px; font-family: 宋体;">里面还定义了一个</span><span lang="EN-US" style="line-height: 22px;">BIO_CONNECT</span><span style="line-height: 22px; font-family: 宋体;">结构来维护底层</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">的地址信息以及状态信息，不过，通过封装，我们一般是不用直接接触该结构的，在此也就不再多做介绍，感兴趣可以参看文件</span><span lang="EN-US" style="line-height: 22px;">bss_conn.c</span><span style="line-height: 22px; font-family: 宋体;">里面的定义和函数。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_read</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_write</span><span style="line-height: 22px; font-family: 宋体;">的操作调用底层的连接的</span><span lang="EN-US" style="line-height: 22px;">IO</span><span style="line-height: 22px; font-family: 宋体;">操作来完成。如果在服务器地址和端口设置正确，但连接没有建立的时候调用读写操作函数，那么会先进行连接的建立操作，然后再进行读写操作。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_puts</span><span style="line-height: 22px; font-family: 宋体;">操作是支持的，但是</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">操作不支持，这在该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构定义中就可以看出来。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">如果关闭标志设置了，那么在</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">被释放的时候，任何活动的连接和</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">都会被关闭。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_reset</span><span style="line-height: 22px; font-family: 宋体;">方法被调用的时候，连接（</span><span lang="EN-US" style="line-height: 22px;">connect</span><span style="line-height: 22px; font-family: 宋体;">）类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的任何活动连接都会被关闭，从而回到可以重新跟同样的主机建立连接的状态。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_get_fd</span><span style="line-height: 22px; font-family: 宋体;">函数返回连接类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的底层</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">，当参数</span><span lang="EN-US" style="line-height: 22px;">c</span><span style="line-height: 22px; font-family: 宋体;">不是</span><span lang="EN-US" style="line-height: 22px;">NULL</span><span style="line-height: 22px; font-family: 宋体;">的时候，就将该</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">赋值给</span><span lang="EN-US" style="line-height: 22px;">c</span><span style="line-height: 22px; font-family: 宋体;">，当然，</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">也作为返回值。</span><span lang="EN-US" style="line-height: 22px;">c</span><span style="line-height: 22px; font-family: 宋体;">参数应该为</span><span lang="EN-US" style="line-height: 22px;">int*</span><span style="line-height: 22px; font-family: 宋体;">类型。如果</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">没有初始化，则返回－</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.2 BIO_set_conn_hostname<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数使用字符串设置主机名，该主机名也可以为</span><span lang="EN-US" style="line-height: 22px;">IP</span><span style="line-height: 22px; font-family: 宋体;">地址的形式，还可以包括端口号，如</span><span lang="EN-US" style="line-height: 22px;">hostname:port</span><span style="line-height: 22px; font-family: 宋体;">，</span><span lang="EN-US" style="line-height: 22px;">hostname/any/other/path</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">hostname:port/any/other/path</span><span style="line-height: 22px; font-family: 宋体;">也是可以的。返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.3 BIO_set_conn_port<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数设置主机的端口号。该端口号的形式可以为数字的形式，也可以为字符串类似</span><span lang="EN-US" style="line-height: 22px;">"http"</span><span style="line-height: 22px; font-family: 宋体;">的形式。如果使用字符串形式，首先会使用</span><span lang="EN-US" style="line-height: 22px;">getservbyname</span><span style="line-height: 22px; font-family: 宋体;">函数搜索其相关的端口，如果没有搜索到，那么就会使用一张缺省的名字端口解释表，目前该表列出的字符串有：</span><span lang="EN-US" style="line-height: 22px;">http, telnet, socks, https, ssl, ftp, gopher&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">和</span>&nbsp;<span lang="EN-US" style="line-height: 22px;">wais.</span><span style="line-height: 22px; font-family: 宋体;">返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">需要注意的是：如果端口名已经作为主机名的一部分设置了，那么它就会覆盖</span><span lang="EN-US" style="line-height: 22px;">BIO_set_conn_port</span><span style="line-height: 22px; font-family: 宋体;">函数设置的端口值。有的时候（如有些应用可能不希望用固定的端口连接）可能不方便，这时候可以通过检测输入主机名的字符串中的</span><span lang="EN-US" style="line-height: 22px;">":"</span><span style="line-height: 22px; font-family: 宋体;">字符，报错或截取字符串来避免这种情况。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.4 BIO_set_conn_ip<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数使用二进制的模式设置</span><span lang="EN-US" style="line-height: 22px;">IP</span><span style="line-height: 22px; font-family: 宋体;">地址。返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.5 BIO_set_conn_int_port<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数以整数形式设置主机端口号，参数应该为</span><span lang="EN-US" style="line-height: 22px;">int*</span><span style="line-height: 22px; font-family: 宋体;">的形式。返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.6 BIO_get_conn_hostname<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回连接类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的主机名，如果</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">以及初始化，但是没有设置主机名，那么返回</span><span lang="EN-US" style="line-height: 22px;">NULL</span><span style="line-height: 22px; font-family: 宋体;">。返回值因为是一个内部指针，所有不能更改它的值。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.7 BIO_get_conn_port<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回字符串类型的端口信息。如果没有设置，就返回</span><span lang="EN-US" style="line-height: 22px;">NULL</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.8 BIO_get_conn_ip<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回二进制形式的</span><span lang="EN-US" style="line-height: 22px;">IP</span><span style="line-height: 22px; font-family: 宋体;">地址。如果没有设置，返回为全</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.9 BIO_get_conn_int_port<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回整数形式的端口号，如果没有设置，则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">上述四个函数的返回值在连接操作完成之后会被更新。而在此之前，返回值都是应用程序自己设置的。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.10 BIO_set_nbio<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">设置</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">的非阻塞标志。如果参数</span><span lang="EN-US" style="line-height: 22px;">n</span><span style="line-height: 22px; font-family: 宋体;">为</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">，则</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">设置为阻塞模式；如果</span><span lang="EN-US" style="line-height: 22px;">n</span><span style="line-height: 22px; font-family: 宋体;">为</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，则</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">设置为非阻塞模式。缺省的模式是阻塞模式。应该在连接建立之前调用本函数，因为非阻塞模式的</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">是在连接过程中设置的。返回值恒为</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">注意：如果是阻塞模式的</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">，执行</span><span lang="EN-US" style="line-height: 22px;">IO</span><span style="line-height: 22px; font-family: 宋体;">操作时（如读写），如果返回负值，说明就产生了错误的情况，如果返回值是</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">，一般来说表明连接已经关闭。如果设置为非阻塞模式，那么发出重试的请求就是很正常的事情了。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.11 BIO_do_connect<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数进行给定</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的连接操作，如果连接成功，返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">或负值。在非阻塞模式的时候，如果调用失败了，可以调用</span><span lang="EN-US" style="line-height: 22px;">BIO_should_retry</span><span style="line-height: 22px; font-family: 宋体;">函数以决定是否需要重试。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">一般来说，应用程序不需要调用本函数，只有在希望将连接过程跟其它</span><span lang="EN-US" style="line-height: 22px;">IO</span><span style="line-height: 22px; font-family: 宋体;">处理过程独立开来的时候，才需要调用本函数。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">在初始化连接的过程的时候，如果返回值失败的原因为</span><span lang="EN-US" style="line-height: 22px;">BIO_RR_CONNECT</span><span style="line-height: 22px; font-family: 宋体;">，调用</span><span lang="EN-US" style="line-height: 22px;">BIO_should_io_special</span><span style="line-height: 22px; font-family: 宋体;">返回值可能也为</span><span lang="EN-US" style="line-height: 22px;">true</span><span style="line-height: 22px; font-family: 宋体;">。如果出现这种情况，说明连接过程被阻塞住了，应用程序应该使用正常的方法进行处理，直到底层的</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">连接上了再重试。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">17.12 BIO_new_connect<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数创建并返回一个连接类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，其实，它调用了</span><span lang="EN-US" style="line-height: 22px;">BIO_s_connect</span><span style="line-height: 22px; font-family: 宋体;">、</span><span lang="EN-US" style="line-height: 22px;">BIO_new</span><span style="line-height: 22px; font-family: 宋体;">已经</span><span lang="EN-US" style="line-height: 22px;">BIO_set_conn_hostname</span><span style="line-height: 22px; font-family: 宋体;">函数完成了整个操作。成功则返回一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">NULL</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">例子：这是一个连接到本地</span><span lang="EN-US" style="line-height: 22px;">Web</span><span style="line-height: 22px; font-family: 宋体;">服务器的例子，返回一页的信息并把该信息复制到标准输出设备。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *cbio, *out;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int len;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char tmpbuf[1024];<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_load_crypto_strings();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">cbio = BIO_new_connect("localhost:http");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">out = BIO_new_fp(stdout, BIO_NOCLOSE);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error connecting to server\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">/* whatever ... */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(cbio, "GET / HTTP/1.0\n\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">for(;;)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">len = BIO_read(cbio, tmpbuf, 1024);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> break;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_write(out, tmpbuf, len);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_free(cbio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free(out);<o p style="line-height: 22px;"></o:p></span></p><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">18.</span><span style="line-height: 33px; font-family: 黑体;">接受</span><span lang="EN-US" style="line-height: 33px;">(accept)</span><span style="line-height: 33px; font-family: 黑体;">类型</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">接受（</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">）类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">跟连接（</span><span lang="EN-US" style="line-height: 22px;">connect</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">是相对应的，它封装了</span><span lang="EN-US" style="line-height: 22px;">Socket</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">方法及其相关的一些操作，使得能够对不同的平台使用同一的函数进行操作。其定义的相关函数如下</span><span lang="EN-US" style="line-height: 22px;">(openssl\bio.h)</span><span style="line-height: 22px; font-family: 宋体;">：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD * BIO_s_accept(void);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_accept_port(b,name) BIO_ctrl(b,BIO_C_SET_ACCEPT,0,(char *)name)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_accept_port(b) BIO_ptr_ctrl(b,BIO_C_GET_ACCEPT,0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *BIO_new_accept(char *host_port);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_nbio_accept(b,n) BIO_ctrl(b,BIO_C_SET_ACCEPT,1,(n)?"a":NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_accept_bios(b,bio) BIO_ctrl(b,BIO_C_SET_ACCEPT,2,(char *)bio)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_bind_mode(b,mode) BIO_ctrl(b,BIO_C_SET_BIND_MODE,mode,NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_bind_mode(b,mode) BIO_ctrl(b,BIO_C_GET_BIND_MODE,0,NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_BIND_NORMAL 0<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_BIND_REUSEADDR_IF_UNUSED 1<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_BIND_REUSEADDR 2<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_do_accept(b) BIO_do_handshake(b)<o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">18.1 BIO_s_accept<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回一个接受（</span><span lang="EN-US" style="line-height: 22px;">Accept</span><span style="line-height: 22px; font-family: 宋体;">）类型的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，其定义如下：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">static BIO_METHOD methods_acceptp=<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_TYPE_ACCEPT,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">"socket accept",<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">acpt_write,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">acpt_read,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">acpt_puts,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* connect_gets, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">acpt_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">acpt_new,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">acpt_free,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">};<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">通过该结构我们可以一目了然的知道该方法支持什么</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">操作，在本类型中，</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">的操作是不支持的。跟连接（</span><span lang="EN-US" style="line-height: 22px;">connect</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">一样，</span><span lang="EN-US" style="line-height: 22px;">openssl</span><span style="line-height: 22px; font-family: 宋体;">也定义了一个维护接受</span><span lang="EN-US" style="line-height: 22px;">Socket</span><span style="line-height: 22px; font-family: 宋体;">信息的结构，在此我也不再详细介绍该结构，大家参考</span><span lang="EN-US" style="line-height: 22px;">bss_acpt.c</span><span style="line-height: 22px; font-family: 宋体;">文件。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">本类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">对各种平台的</span><span lang="EN-US" style="line-height: 22px;">TCP/IP</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">做了封装，所以在使用的时候就可以同一的使用</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的规则进行操作，而不用担心因为不同的平台带来程序改写或增加移植的工作量，这也是</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">很重要的一个目的。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_read</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_write</span><span style="line-height: 22px; font-family: 宋体;">函数操作调用了底层平台连接的</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">相关操作，如果这时候没有连接建立，端口设置正确，那么该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">就会等待连接的建立。事实上，当一个连接建立的时候，一个新的</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">就会被创建并附加到</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中，形成</span><span lang="EN-US" style="line-height: 22px;">accept-&gt;socket</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">结构，所以这时候对初始化了的接受</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">进行</span><span lang="EN-US" style="line-height: 22px;">IO</span><span style="line-height: 22px; font-family: 宋体;">操作就会导致它处于等待连接建立的状态。当一个接受类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">在</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链的末尾的时候，在处理</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">调用之前它会先等待一个连接的建立；如果不是在末尾，那么它简单的把</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">调用传到下一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">如果接受（</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的关闭标志设置了，那么当</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">被释放的时候，该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链上任何活动的连接和</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">都会被关闭。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_get_fd</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_set_fd</span><span style="line-height: 22px; font-family: 宋体;">可以用来取得和设置该连接的</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">描述符，详细情况参看“</span><span lang="EN-US" style="line-height: 22px;">12.</span><span style="line-height: 22px; font-family: 宋体;">描述符</span><span lang="EN-US" style="line-height: 22px;">(fd)&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">”。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">18.2 BIO_set_accept_port<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数使用字串名来设置接受端口。其形式为“</span><span lang="EN-US" style="line-height: 22px;">host:port</span><span style="line-height: 22px; font-family: 宋体;">”，“</span><span lang="EN-US" style="line-height: 22px;">host</span><span style="line-height: 22px; font-family: 宋体;">”是要使用的接口，“</span><span lang="EN-US" style="line-height: 22px;">port</span><span style="line-height: 22px; font-family: 宋体;">”是端口。这两部分都可以为“</span><span lang="EN-US" style="line-height: 22px;">*</span><span style="line-height: 22px; font-family: 宋体;">”，这时候表示可以使用任意接口和端口。这里的端口的字符串含义跟连接（</span><span lang="EN-US" style="line-height: 22px;">connect</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">里面定义的一样，可以为数字形式的，可以使用</span><span lang="EN-US" style="line-height: 22px;">getservbyname</span><span style="line-height: 22px; font-family: 宋体;">函数去匹配得到，还可以使用字符串的表，请参看连接型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">说明的相关部分。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">18.3 BIO_new_accept<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数将</span><span lang="EN-US" style="line-height: 22px;">BIO_new</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_set_accept_port</span><span style="line-height: 22px; font-family: 宋体;">函数放在一个函数里面调用，创建一个新的接受（</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">）类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">18.4 BIO_set_nbio_accept<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数设置接受</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">是否为阻塞模式（缺省），如果参数</span><span lang="EN-US" style="line-height: 22px;">n</span><span style="line-height: 22px; font-family: 宋体;">为</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">，为阻塞模式，</span><span lang="EN-US" style="line-height: 22px;">n</span><span style="line-height: 22px; font-family: 宋体;">为</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">则为非阻塞模式。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">18.5 BIO_set_accept_bios<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数用来设置一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链，当接受到一个连接的时候，这个设置好的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链就会被复制或附加到整个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链上来。有的时候这中处理方法是非常好的，比如，如果每个连接都需要一个缓冲区或</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，这时候使用本函数就省了很多麻烦了。需要注意的是，在调用本函数后，这个设置的链上的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">不能自己释放，在接受（</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">）</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">被释放后，它们会自动释放。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">当该函数调用的时候，其设置的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链位于接受</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">之间，即形成：</span><span lang="EN-US" style="line-height: 22px;">accept-&gt;otherbios-&gt;socket</span><span style="line-height: 22px; font-family: 宋体;">的新的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">18.6 BIO_set_bind_mode</span><span style="line-height: 25px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 25px;">BIO_get_bind_mode<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">这两个函数用来设置和取得目前的绑定模式。如果设置为</span><span lang="EN-US" style="line-height: 22px;">BIO_BIND_NORMAL</span><span style="line-height: 22px; font-family: 宋体;">（缺省），那么另外一个</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">就不能绑定到同一个端口。如果设置为</span><span lang="EN-US" style="line-height: 22px;">BIO_BIND_REUSEADDR</span><span style="line-height: 22px; font-family: 宋体;">，那么另外的</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">可以绑定到同一个端口。如果设置为</span><span lang="EN-US" style="line-height: 22px;">BIO_BIND_REUSEADDR_IF_UNUSED</span><span style="line-height: 22px; font-family: 宋体;">，那么首先会尝试以</span><span lang="EN-US" style="line-height: 22px;">BIO_BIND_NORMAL</span><span style="line-height: 22px; font-family: 宋体;">的模式绑定到端口，如果失败了而且端口没有使用，那么就会使用</span><span lang="EN-US" style="line-height: 22px;">BIO_BIND_REUSEADDR</span><span style="line-height: 22px; font-family: 宋体;">模式绑定到端口。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">18.7 BIO_do_accept<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数有两个功能，当它在接受（</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">）</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">设置好之后第一被调用的时候，它会创建一个接受</span><span lang="EN-US" style="line-height: 22px;">socket</span><span style="line-height: 22px; font-family: 宋体;">并把它跟地址绑定；第二次被调用的时候，它会等待连接的到来。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">注意：如果服务器端希望可以处理多个连接的情况（通常都是这样的），那么接受</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">必须能够用来处理以后的连接，这时候可以这样做：等待到一个连接后，调用</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">connection=BIO_pop(accept)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">这样，</span><span lang="EN-US" style="line-height: 22px;">connection</span><span style="line-height: 22px; font-family: 宋体;">会包含一个最近建立的连接的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">就再次成为一个独立的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，可以用来处理其它连接了。如果没有其它连接建立，那么就可以使用</span><span lang="EN-US" style="line-height: 22px;">BIO_free</span><span style="line-height: 22px; font-family: 宋体;">释放该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">当然，如果只有一个连接需要处理，也可以使用连接</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">本身来进行</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">操作。但是一般来说不推荐这样做，因为这时候该接受</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">依然处于接受其它连接建立的状态。这可以使用上述的方法解决。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">例子：这个例子在</span><span lang="EN-US" style="line-height: 22px;">4444</span><span style="line-height: 22px; font-family: 宋体;">端口接受了两个连接，发送信息到每个连接上然后释放他们。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *abio, *cbio, *cbio2;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_load_crypto_strings();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">abio = BIO_new_accept("4444");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">首先调用</span><span lang="EN-US" style="line-height: 22px;">BIO_accept</span><span style="line-height: 22px; font-family: 宋体;">启动接受</span><span lang="EN-US" style="line-height: 22px;">BIO */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error setting up accept\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">exit(0);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">等待连接建立</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error accepting connection\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">exit(0);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Connection 1 established\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">返回连接的</span><span lang="EN-US" style="line-height: 22px;">BIO*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">cbio = BIO_pop(abio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(cbio, "Connection 1: Sending out Data on initial connection\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Sent out data on connection 1\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">等待另一个连接的建立</span><span lang="EN-US" style="line-height: 22px;">&nbsp;*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error accepting connection\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">exit(0);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Connection 2 established\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">关闭连接</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，不再接受连接的建立</span><span lang="EN-US" style="line-height: 22px;">&nbsp;*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">cbio2 = BIO_pop(abio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free(abio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(cbio2, "Connection 2: Sending out Data on second\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Sent out data on connection 2\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(cbio, "Connection 1: Second connection established\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">关闭这两个连接</span><span lang="EN-US" style="line-height: 22px;">&nbsp;*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free(cbio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free(cbio2);<o p style="line-height: 22px;"></o:p></span></p><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">19.Fileter</span><span style="line-height: 33px; font-family: 黑体;">类型的</span><span lang="EN-US" style="line-height: 33px;">NULL</span><span style="line-height: 33px; font-family: 黑体;">型</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">前面我们已经介绍完</span><span lang="EN-US" style="line-height: 22px;">source/sink</span><span style="line-height: 22px; font-family: 宋体;">型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">了，以后的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">系列文章将开始介绍过滤</span><span lang="EN-US" style="line-height: 22px;">(filter)</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。那么首先介绍的是一个非常简单的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">类型——</span><span lang="EN-US" style="line-height: 22px;">NULL</span><span style="line-height: 22px; font-family: 宋体;">型</span><span lang="EN-US" style="line-height: 22px;">filter BIO</span><span style="line-height: 22px; font-family: 宋体;">，其定义如下（</span><span lang="EN-US" style="line-height: 22px;">openssl\bio.h</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD * BIO_f_null(void);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">在本类型中，只有这个函数是定义了的，该函数返回一个</span><span lang="EN-US" style="line-height: 22px;">NULL</span><span style="line-height: 22px; font-family: 宋体;">型的过滤</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，</span><span lang="EN-US" style="line-height: 22px;">NULL</span><span style="line-height: 22px; font-family: 宋体;">过滤型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">是一个不作任何事情的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。针对该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的任何调用都会被简单传递中</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中的下一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">中去，也就相当于该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">是不存在的一样。所以，一般来说，该类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">用处不大。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">20.</span><span style="line-height: 33px; font-family: 黑体;">缓冲（</span><span lang="EN-US" style="line-height: 33px;">buffer</span><span style="line-height: 33px; font-family: 黑体;">）类型</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">缓冲（</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">是一种过滤（</span><span lang="EN-US" style="line-height: 22px;">filter</span><span style="line-height: 22px; font-family: 宋体;">）型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，其相关的一些函数定义如下（</span><span lang="EN-US" style="line-height: 22px;">openssl\bio.h</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD * BIO_f_buffer(void);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_buffer_num_lines(b) BIO_ctrl(b,BIO_C_GET_BUFF_NUM_LINES,0,NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_read_buffer_size(b,size) BIO_int_ctrl(b,BIO_C_SET_BUFF_SIZE,size,0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_write_buffer_size(b,size) BIO_int_ctrl(b,BIO_C_SET_BUFF_SIZE,size,1)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_buffer_size(b,size) BIO_ctrl(b,BIO_C_SET_BUFF_SIZE,size,NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_buffer_read_data(b,buf,num) BIO_ctrl(b,BIO_C_SET_BUFF_READ_DATA,num,buf)<o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">20.1 BIO_f_buffer<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回一个</span><span lang="EN-US" style="line-height: 22px;">Buffer</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，该结构定义如下（</span><span lang="EN-US" style="line-height: 22px;">bf_buff.c</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">static BIO_METHOD methods_buffer=<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_TYPE_BUFFER,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">"buffer",<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_write,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_read,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_puts,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_gets,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_new,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_free,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">buffer_callback_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">};<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">由结构定义可见，该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">支持所有</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">函数。写入缓冲</span><span lang="EN-US" style="line-height: 22px;">(buffer)BIO</span><span style="line-height: 22px; font-family: 宋体;">的数据存储在缓冲区里面，定期写入到</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链的下一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">中，事实上，只有缓冲区已满或者调用了</span><span lang="EN-US" style="line-height: 22px;">BIO_flush</span><span style="line-height: 22px; font-family: 宋体;">函数时，数据才会写入下面的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，所以，当任何存储在缓冲区的数据需要写入的时候（如在使用</span><span lang="EN-US" style="line-height: 22px;">BIO_pop</span><span style="line-height: 22px; font-family: 宋体;">函数从</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中删除一个</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">之前），必须使用</span><span lang="EN-US" style="line-height: 22px;">BIO_flush</span><span style="line-height: 22px; font-family: 宋体;">函数，如果</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链的末尾是一个非阻塞型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，有时候调用</span><span lang="EN-US" style="line-height: 22px;">BIO_flush</span><span style="line-height: 22px; font-family: 宋体;">可能出现失败，需要重试的情况。从该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">读取数据时，数据从下一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">填充到该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的内部缓冲区中，然后再读出来。该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">支持</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_puts</span><span style="line-height: 22px; font-family: 宋体;">方法，事实上，</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">函数是通过在下一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">BIO_read</span><span style="line-height: 22px; font-family: 宋体;">函数来实现的，所以，如果一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">不支持</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">方法（如</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">），可以通过预先附加一个</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">来实现</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">的功能。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_reset</span><span style="line-height: 22px; font-family: 宋体;">被调用的时候，该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">里面的所有数据都会被清空。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">20.2 BIO_get_buffer_num_lines<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">返回缓冲区中目前数据的的行数。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">20.3 BIO_set_read_buffer_size</span><span style="line-height: 25px; font-family: 宋体;">、</span><span lang="EN-US" style="line-height: 25px;">BIO_set_write_buffer_size</span><span style="line-height: 25px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 25px;">BIO_set_buffer_size<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">这三个函数分别设置缓冲类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的读、写或者读写缓冲区的大小。初始的缓冲区大小由宏定义</span><span lang="EN-US" style="line-height: 22px;">DEFAULT_BUFFER_SIZE</span><span style="line-height: 22px; font-family: 宋体;">决定，默认的是</span><span lang="EN-US" style="line-height: 22px;">1024</span><span style="line-height: 22px; font-family: 宋体;">。如果设置的缓冲区大小小于</span><span lang="EN-US" style="line-height: 22px;">DEFAULT_BUFFER_SIZE</span><span style="line-height: 22px; font-family: 宋体;">，那么就会被忽略，也就是说缓冲区大小会保持为</span><span lang="EN-US" style="line-height: 22px;">DEFAULT_BUFFER_SIZE</span><span style="line-height: 22px; font-family: 宋体;">所定义的大小。当重新设置缓冲区大小时，里面的数据会全部被清空。成功执行返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">20.4 BIO_set_buffer_read_data<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数清空缓冲区原有的数据，并使用</span><span lang="EN-US" style="line-height: 22px;">num</span><span style="line-height: 22px; font-family: 宋体;">个</span><span lang="EN-US" style="line-height: 22px;">buf</span><span style="line-height: 22px; font-family: 宋体;">中的数据填充该缓冲区，如果</span><span lang="EN-US" style="line-height: 22px;">num</span><span style="line-height: 22px; font-family: 宋体;">的大小大于目前的缓冲区设定大小，那么缓冲区就会自动扩大。成功设置返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">21.Base64</span><span style="line-height: 33px; font-family: 黑体;">类型</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该类型为过滤（</span><span lang="EN-US" style="line-height: 22px;">filter</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，其定义如下（</span><span lang="EN-US" style="line-height: 22px;">openssl\bio.h,openssl\evp.h</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD * BIO_f_base64(void);<o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">21.1 BIO_f_base64<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回一个</span><span lang="EN-US" style="line-height: 22px;">Base64</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，该结构定义如下（</span><span lang="EN-US" style="line-height: 22px;">evp\bio_b64.c</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">static BIO_METHOD methods_b64=<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_TYPE_BASE64,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">"base64 encoding",<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64_write,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64_read,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* b64_puts, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* b64_gets, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64_new,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64_free,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64_callback_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">};<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">应该注意的是，该类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">其定义并不在</span><span lang="EN-US" style="line-height: 22px;">bio</span><span style="line-height: 22px; font-family: 宋体;">目录下，而是在</span><span lang="EN-US" style="line-height: 22px;">evp</span><span style="line-height: 22px; font-family: 宋体;">目录下。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">当往该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">写入数据时，数据被</span><span lang="EN-US" style="line-height: 22px;">Base64</span><span style="line-height: 22px; font-family: 宋体;">编码，当从该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">读数据时，数据被</span><span lang="EN-US" style="line-height: 22px;">Base64</span><span style="line-height: 22px; font-family: 宋体;">解码。该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">不支持</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_puts</span><span style="line-height: 22px; font-family: 宋体;">的功能。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_flush</span><span style="line-height: 22px; font-family: 宋体;">在该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">被调用的时候，表示需要写入的数据已经写完，用来把最后的一段数据写入到</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">里面去。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">21.2 BIO_set_flags<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数可以用来设置标记</span><span lang="EN-US" style="line-height: 22px;">BIO_FLAGS_BASE64_NO_NL</span><span style="line-height: 22px; font-family: 宋体;">，该标记设置后，将把所有数据编码成为一行或者说期望所有数据都在一行上。需要注意的是，由于</span><span lang="EN-US" style="line-height: 22px;">base64</span><span style="line-height: 22px; font-family: 宋体;">编码本身格式的原因，不能准确可靠的决定编码后的数据块的结束位置，大家使用的时候自己需要注意数据的长度问题。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">例子：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">、下面的程序将字符串</span><span lang="EN-US" style="line-height: 22px;">"Hello World\n"</span><span style="line-height: 22px; font-family: 宋体;">进行</span><span lang="EN-US" style="line-height: 22px;">base64</span><span style="line-height: 22px; font-family: 宋体;">编码并写入到标准输出设备。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *bio, *b64;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char message[] = "Hello World \n";<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;">&nbsp;</o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64 = BIO_new(BIO_f_base64());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_new_fp(stdout, BIO_NOCLOSE);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_push(b64, bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_write(bio, message, strlen(message));<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_flush(bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;">&nbsp;</o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_free_all(bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">2</span><span style="line-height: 22px; font-family: 宋体;">、下面的程序将</span><span lang="EN-US" style="line-height: 22px;">base64</span><span style="line-height: 22px; font-family: 宋体;">编码的数据从标准输入设备读出并将解码数据输出到标准输出设备：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *bio, *b64, bio_out;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char inbuf[512];<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int inlen;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char message[] = "Hello World \n";<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;">&nbsp;</o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">b64 = BIO_new(BIO_f_base64());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_new_fp(stdin, BIO_NOCLOSE);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio_out = BIO_new_fp(stdout, BIO_NOCLOSE);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_push(b64, bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">while((inlen = BIO_read(bio, inbuf, strlen(message))) &gt; 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_write(bio_out, inbuf, inlen);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_free_all(bio);<o p style="line-height: 22px;"></o:p></span></p><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">22.Cipher</span><span style="line-height: 33px; font-family: 黑体;">类型</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该类型为过滤（</span><span lang="EN-US" style="line-height: 22px;">filter</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，其定义如下（</span><span lang="EN-US" style="line-height: 22px;">openssl\bio.h,openssl\evp.h</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD * BIO_f_cipher(void);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">void BIO_set_cipher(BIO *b,const EVP_CIPHER *cipher,unsigned char *key, unsigned char *iv, int enc);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int BIO_get_cipher_status(BIO *b)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int BIO_get_cipher_ctx(BIO *b, EVP_CIPHER_CTX **pctx)<o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">22.1 BIO_f_cipher<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回</span><span lang="EN-US" style="line-height: 22px;">cipher</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，其结构定义如下（</span><span lang="EN-US" style="line-height: 22px;">evp\bio_enc.c</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">static BIO_METHOD methods_enc=<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_TYPE_CIPHER,"cipher",<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">enc_write,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">enc_read,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* enc_puts, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* enc_gets, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">enc_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">enc_new,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">enc_free,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">enc_callback_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">};<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">将写入该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的数据加密，从该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">读数据时数据被解密，它事实上封装了</span><span lang="EN-US" style="line-height: 22px;">EVP_CipherInit</span><span style="line-height: 22px; font-family: 宋体;">、</span><span lang="EN-US" style="line-height: 22px;">EVP_CipherUpdate</span><span style="line-height: 22px; font-family: 宋体;">、</span><span lang="EN-US" style="line-height: 22px;">EVP_CipherFinal</span><span style="line-height: 22px; font-family: 宋体;">三种方法。它不支持</span><span lang="EN-US" style="line-height: 22px;">BIO_puts</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">的方法，如果要使用这两个方法，可以通过在前面附加一个</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">来实现，这在前面我们介绍过。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">跟</span><span lang="EN-US" style="line-height: 22px;">base64</span><span style="line-height: 22px; font-family: 宋体;">型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">相似，当调用</span><span lang="EN-US" style="line-height: 22px;">BIO_flush</span><span style="line-height: 22px; font-family: 宋体;">函数时，表明所有数据都已经通过该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">加密了，用来将最后的一段数据通过该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">进行加密。在进行加密的时候，必须调用</span><span lang="EN-US" style="line-height: 22px;">BIO_flush</span><span style="line-height: 22px; font-family: 宋体;">函数来把最后的数据通过</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">进行加密，否则最后的数据会在解密的时候出现失败的情况。当从一个加密类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">读取数据时，当读到最后一段数据时，会通过检测</span><span lang="EN-US" style="line-height: 22px;">EOF</span><span style="line-height: 22px; font-family: 宋体;">自动检测到数据结束标志并自动将这段数据解密。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">22.2 BIO_set_cipher<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数设置该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的加密算法，数据使用参数</span><span lang="EN-US" style="line-height: 22px;">key</span><span style="line-height: 22px; font-family: 宋体;">为加密密钥，参数</span><span lang="EN-US" style="line-height: 22px;">iv</span><span style="line-height: 22px; font-family: 宋体;">作为加密的</span><span lang="EN-US" style="line-height: 22px;">IV</span><span style="line-height: 22px; font-family: 宋体;">（初始化向量）。如果</span><span lang="EN-US" style="line-height: 22px;">enc</span><span style="line-height: 22px; font-family: 宋体;">设置为</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，则为加密，</span><span lang="EN-US" style="line-height: 22px;">enc</span><span style="line-height: 22px; font-family: 宋体;">设置为</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">，则为解密。该函数不返回值。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">22.3 BIO_get_cipher_status<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数是一个</span><span lang="EN-US" style="line-height: 22px;">BIO_ctrl</span><span style="line-height: 22px; font-family: 宋体;">的宏，用来检测解密是否成功执行。因为在解密的时候（执行读操作的时候），如果最后一段数据发生错误，会返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">，而遇到</span><span lang="EN-US" style="line-height: 22px;">EOF</span><span style="line-height: 22px; font-family: 宋体;">成功完成操作后也会返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">，所以必须调用本函数确定解密操作是否成功执行了。解密成功返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">22.4 BIO_get_cipher_ctx<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数也是</span><span lang="EN-US" style="line-height: 22px;">BIO_ctrl</span><span style="line-height: 22px; font-family: 宋体;">的一个宏定义函数，它返回</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的内部加密体制。返回的加密体制可以使用标准的加密规则进行设置。这在</span><span lang="EN-US" style="line-height: 22px;">BIO_set_cipher</span><span style="line-height: 22px; font-family: 宋体;">函数的灵活性不能适应应用程序的需要的时候是很有用的。该函数总是返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">23.MD</span><span style="line-height: 33px; font-family: 黑体;">类型</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该类型为过滤（</span><span lang="EN-US" style="line-height: 22px;">filter</span><span style="line-height: 22px; font-family: 宋体;">）类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，其定义如下（</span><span lang="EN-US" style="line-height: 22px;">openssl\bio.h,openssl\evp.h</span><span style="line-height: 22px; font-family: 宋体;">）：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD * BIO_f_md(void);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int BIO_set_md(BIO *b,EVP_MD *md);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int BIO_get_md(BIO *b,EVP_MD **mdp);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int BIO_get_md_ctx(BIO *b,EVP_MD_CTX **mdcp);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">跟</span><span lang="EN-US" style="line-height: 22px;">Cipher</span><span style="line-height: 22px; font-family: 宋体;">类型一样，该类型的一些定义和实现文件是在</span><span lang="EN-US" style="line-height: 22px;">evp\bio_md.c</span><span style="line-height: 22px; font-family: 宋体;">里面，而不是在</span><span lang="EN-US" style="line-height: 22px;">bio</span><span style="line-height: 22px; font-family: 宋体;">目录下。大家要看源文件，请参看这个文件。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">23.1 BIO_f_md<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回一个</span><span lang="EN-US" style="line-height: 22px;">MD</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，其定义如下：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">static BIO_METHOD methods_md=<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_TYPE_MD,"message digest",<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">md_write,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">md_read,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* md_puts, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">md_gets,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">md_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">md_new,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">md_free,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">md_callback_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">};<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">MD</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">对通过它的任何数据都进行摘要操作（</span><span lang="EN-US" style="line-height: 22px;">digest</span><span style="line-height: 22px; font-family: 宋体;">），事实上，该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">封装了</span><span lang="EN-US" style="line-height: 22px;">EVP_DigestInit</span><span style="line-height: 22px; font-family: 宋体;">、</span><span lang="EN-US" style="line-height: 22px;">EVP_DigestUpdate</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">EVP_DigestFinal</span><span style="line-height: 22px; font-family: 宋体;">三个函数的功能和行为。该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">是完全对称的，也就是说，不管是读数据（</span><span lang="EN-US" style="line-height: 22px;">BIO_read</span><span style="line-height: 22px; font-family: 宋体;">）还是写数据（</span><span lang="EN-US" style="line-height: 22px;">BIO_write</span><span style="line-height: 22px; font-family: 宋体;">），都进行相同的摘要操作。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">函数执行的时候，如果给定的</span><span lang="EN-US" style="line-height: 22px;">size</span><span style="line-height: 22px; font-family: 宋体;">参数足够大，可以完成摘要（</span><span lang="EN-US" style="line-height: 22px;">digest</span><span style="line-height: 22px; font-family: 宋体;">）计算，那么就会返回摘要值。</span><span lang="EN-US" style="line-height: 22px;">BIO_puts</span><span style="line-height: 22px; font-family: 宋体;">函数是不支持的，如果需要支持该函数，可以在前面附加一个</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_reset</span><span style="line-height: 22px; font-family: 宋体;">函数重新初始化一个摘要类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，事实上，它是简单重新调用了</span><span lang="EN-US" style="line-height: 22px;">EVP_DigestInit</span><span style="line-height: 22px; font-family: 宋体;">函数进行初始化。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">注意，在从一个摘要</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">里面读取完摘要信息之后，在重新使用该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">之前，必须调用</span><span lang="EN-US" style="line-height: 22px;">BIO_reset</span><span style="line-height: 22px; font-family: 宋体;">或</span><span lang="EN-US" style="line-height: 22px;">BIO_set_md</span><span style="line-height: 22px; font-family: 宋体;">重新初始化该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">才行。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">23.2 BIO_set_md<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数是一个</span><span lang="EN-US" style="line-height: 22px;">BIO_ctrl</span><span style="line-height: 22px; font-family: 宋体;">函数的宏定义函数，它使用参数</span><span lang="EN-US" style="line-height: 22px;">md</span><span style="line-height: 22px; font-family: 宋体;">设置给定</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的摘要算法。该函数必须在执行读写操作之前调用，用来初始化一个摘要类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。调用成功返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">23.3 BIO_get_md<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数也是</span><span lang="EN-US" style="line-height: 22px;">BIO_ctrl</span><span style="line-height: 22px; font-family: 宋体;">函数一个宏定义。它返回</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">摘要方法的指针到</span><span lang="EN-US" style="line-height: 22px;">mdp</span><span style="line-height: 22px; font-family: 宋体;">参数里面。调用成功返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">23.4 BIO_get_md_ctx<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回摘要</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的方法结构到</span><span lang="EN-US" style="line-height: 22px;">mdcp</span><span style="line-height: 22px; font-family: 宋体;">参数里面。该结构可以作为参数使用在</span><span lang="EN-US" style="line-height: 22px;">EVP_DigestFinal</span><span style="line-height: 22px; font-family: 宋体;">、</span><span lang="EN-US" style="line-height: 22px;">EVP_SignFinal</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">EVP_VerifyFinal</span><span style="line-height: 22px; font-family: 宋体;">函数里，这增加了灵活性。因为该函数返回的结构是一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">内部的结构，所以对该结构的任何改变操作都会影响到相应的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，并且如果该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">释放了，该结构指针也就无效了。调用成功返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">例子</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">、下列的例子创建一个包含</span><span lang="EN-US" style="line-height: 22px;">SHA1</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">MD5</span><span style="line-height: 22px; font-family: 宋体;">类型摘要</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链，并将数据</span><span lang="EN-US" style="line-height: 22px;">"Hello World"</span><span style="line-height: 22px; font-family: 宋体;">通过它们进行摘要操作。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *bio, *mdtmp;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char message[] = "Hello World";<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_new(BIO_s_null());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdtmp = BIO_new(BIO_f_md());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_set_md(mdtmp, EVP_sha1());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;">&nbsp;</o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">//&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">使用</span><span lang="EN-US" style="line-height: 22px;">BIO_push</span><span style="line-height: 22px; font-family: 宋体;">在</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链前面增加一个</span><span lang="EN-US" style="line-height: 22px;">sink</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，作为</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链开始的标志</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_push(mdtmp, bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdtmp = BIO_new(BIO_f_md());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_set_md(mdtmp, EVP_md5());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_push(mdtmp, bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">注意，现在</span><span lang="EN-US" style="line-height: 22px;">mdtmp</span><span style="line-height: 22px; font-family: 宋体;">变量已经没有用了</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_write(bio, message, strlen(message));//</span><span style="line-height: 22px; font-family: 宋体;">因为最后一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">是</span><span lang="EN-US" style="line-height: 22px;">null</span><span style="line-height: 22px; font-family: 宋体;">型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，所以数据实际上已经自动被丢弃了。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">2</span><span style="line-height: 22px; font-family: 宋体;">、下面的例子演示了从摘要类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">读数据的过程：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *bio, *mdtmp;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char buf[1024];<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int rdlen;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_new_file(file, "rb");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdtmp = BIO_new(BIO_f_md());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_set_md(mdtmp, EVP_sha1());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_push(mdtmp, bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdtmp = BIO_new(BIO_f_md());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_set_md(mdtmp, EVP_md5());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">bio = BIO_push(mdtmp, bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">do<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">rdlen = BIO_read(bio, buf, sizeof(buf));<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">可以在这里面加入处理数据的代码</span><span lang="EN-US" style="line-height: 22px;">&nbsp;*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">} while(rdlen &gt; 0);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">3</span><span style="line-height: 22px; font-family: 宋体;">、下面的例子从一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中读取摘要数据并输出。可以跟上面的例子一起使用。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *mdtmp;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">unsigned char mdbuf[EVP_MAX_MD_SIZE];<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int mdlen;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int i;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdtmp = bio; /*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">这里假设</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">已经设置好了</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">do<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">EVP_MD *md;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdtmp = BIO_find_type(mdtmp, BIO_TYPE_MD);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> break;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_get_md(mdtmp, &amp;md);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">printf("%s digest", OBJ_nid2sn(EVP_MD_type(md)));<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdlen = BIO_gets(mdtmp, mdbuf, EVP_MAX_MD_SIZE);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">for(i = 0; i &lt; mdlen; i++) printf(":%02X", mdbuf[i]);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">printf("\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">mdtmp = BIO_next(mdtmp);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">} while(mdtmp);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free_all(bio);<o p style="line-height: 22px;"></o:p></span></p><h2 style="line-height: 33px;"><span lang="EN-US" style="line-height: 33px;">24.SSL</span><span style="line-height: 33px; font-family: 黑体;">类型的</span><span lang="EN-US" style="line-height: 33px;">BIO<o p style="line-height: 33px;"></o:p></span></h2><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">从名字就可以看出，这是一个非常重要的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">类型，它封装了</span><span lang="EN-US" style="line-height: 22px;">openssl</span><span style="line-height: 22px; font-family: 宋体;">里面的</span><span lang="EN-US" style="line-height: 22px;">ssl</span><span style="line-height: 22px; font-family: 宋体;">规则和函数，相当于提供了一个使用</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">很好的有效工具，一个很好的助手。其定义（</span><span lang="EN-US" style="line-height: 22px;">openssl\bio.h,openssl\ssl.h</span><span style="line-height: 22px; font-family: 宋体;">）如下：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_METHOD *BIO_f_ssl(void);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_ssl(b,ssl,c) BIO_ctrl(b,BIO_C_SET_SSL,c,(char *)ssl)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_ssl(b,sslp) BIO_ctrl(b,BIO_C_GET_SSL,0,(char *)sslp)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_ssl_mode(b,client) BIO_ctrl(b,BIO_C_SSL_MODE,client,NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_ssl_renegotiate_bytes(b,num) BIO_ctrl(b,BIO_C_SET_SSL_RENEGOTIATE_BYTES,num,NULL);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_set_ssl_renegotiate_timeout(b,seconds) BIO_ctrl(b,BIO_C_SET_SSL_RENEGOTIATE_TIMEOUT,seconds,NULL);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_get_num_renegotiates(b) BIO_ctrl(b,BIO_C_SET_SSL_NUM_RENEGOTIATES,0,NULL);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *BIO_new_ssl(SSL_CTX *ctx,int client);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *BIO_new_ssl_connect(SSL_CTX *ctx);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *BIO_new_buffer_ssl_connect(SSL_CTX *ctx);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int BIO_ssl_copy_session_id(BIO *to,BIO *from);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">void BIO_ssl_shutdown(BIO *bio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">#define BIO_do_handshake(b) BIO_ctrl(b,BIO_C_DO_STATE_MACHINE,0,NULL)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的实现文件在</span><span lang="EN-US" style="line-height: 22px;">ssl\bio_ssl.c</span><span style="line-height: 22px; font-family: 宋体;">里面，大家可以参看这个文件得到详细的函数实现信息。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.1 BIO_f_ssl<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回一个</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO_METHOD</span><span style="line-height: 22px; font-family: 宋体;">结构，其定义如下：</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">static BIO_METHOD methods_sslp=<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_TYPE_SSL,"ssl",<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ssl_write,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ssl_read,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ssl_puts,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">NULL, /* ssl_gets, */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ssl_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ssl_new,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ssl_free,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ssl_callback_ctrl,<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">};<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">可见，</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">不支持</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">的功能。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_read</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">BIO_write</span><span style="line-height: 22px; font-family: 宋体;">函数调用的时候，</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">会使用</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">协议进行底层的</span><span lang="EN-US" style="line-height: 22px;">I/O</span><span style="line-height: 22px; font-family: 宋体;">操作。如果此时</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接并没有建立，那么就会在调用第一个</span><span lang="EN-US" style="line-height: 22px;">IO</span><span style="line-height: 22px; font-family: 宋体;">函数的时候先进行连接的建立。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">如果使用</span><span lang="EN-US" style="line-height: 22px;">BIO_push</span><span style="line-height: 22px; font-family: 宋体;">将一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">附加到一个</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">上，那么</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">读写数据的时候，它会被自动调用。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_reset</span><span style="line-height: 22px; font-family: 宋体;">调用的时候，会调用</span><span lang="EN-US" style="line-height: 22px;">SSL_shutdown</span><span style="line-height: 22px; font-family: 宋体;">函数关闭目前所有处于连接状态的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">，然后再对下一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">调用</span><span lang="EN-US" style="line-height: 22px;">BIO_reset</span><span style="line-height: 22px; font-family: 宋体;">，这功能一般就是将底层的传输连接断开。调用完成之后，</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">就处于初始的接受或连接状态。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">如果设置了</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">关闭标志，那么</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">释放的时候，内部的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">结构也会被</span><span lang="EN-US" style="line-height: 22px;">SSL_free</span><span style="line-height: 22px; font-family: 宋体;">函数释放。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.2 BIO_set_ssl<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数设置</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的内部</span><span lang="EN-US" style="line-height: 22px;">ssl</span><span style="line-height: 22px; font-family: 宋体;">指针指向</span><span lang="EN-US" style="line-height: 22px;">ssl</span><span style="line-height: 22px; font-family: 宋体;">，同时使用参数</span><span lang="EN-US" style="line-height: 22px;">c</span><span style="line-height: 22px; font-family: 宋体;">设置了关闭标志。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.3 BIO_get_ssl<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的内部的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">结构指针，得到该指针后，可以使用标志的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">函数对它进行操作。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.4 BIO_set_ssl_mode<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数设置</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">的工作模式，如果参数</span><span lang="EN-US" style="line-height: 22px;">client</span><span style="line-height: 22px; font-family: 宋体;">是</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，那么</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">工作模式为客户端模式，如果</span><span lang="EN-US" style="line-height: 22px;">client</span><span style="line-height: 22px; font-family: 宋体;">为</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">，那么</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">工作模式为服务器模式。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.5 BIO_set_ssl_renegotiate_bytes<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数设置需要重新进行</span><span lang="EN-US" style="line-height: 22px;">session</span><span style="line-height: 22px; font-family: 宋体;">协商的读写数据的长度为</span><span lang="EN-US" style="line-height: 22px;">num</span><span style="line-height: 22px; font-family: 宋体;">。当设置完成后，在没读写的数据一共到达</span><span lang="EN-US" style="line-height: 22px;">num</span><span style="line-height: 22px; font-family: 宋体;">字节后，</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接就会自动重新进行</span><span lang="EN-US" style="line-height: 22px;">session</span><span style="line-height: 22px; font-family: 宋体;">协商，这可以加强</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接的安全性。参数</span><span lang="EN-US" style="line-height: 22px;">num</span><span style="line-height: 22px; font-family: 宋体;">最少为</span><span lang="EN-US" style="line-height: 22px;">512</span><span style="line-height: 22px; font-family: 宋体;">字节。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.6 BIO_set_ssl_renegotiate_timeout<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数跟上述函数一样都是为了加强</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接的安全性的。不同的是，该函数采用的参数是时间。该函数设置重新进行</span><span lang="EN-US" style="line-height: 22px;">session</span><span style="line-height: 22px; font-family: 宋体;">协商的时间，其单位是秒。当</span><span lang="EN-US" style="line-height: 22px;">SSL session</span><span style="line-height: 22px; font-family: 宋体;">连接建立的时间到达其设置的时间时，连接就会自动重新进行</span><span lang="EN-US" style="line-height: 22px;">session</span><span style="line-height: 22px; font-family: 宋体;">协商。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.7 BIO_get_num_renegotiates<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数返回</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接在因为字节限制或时间限制导致</span><span lang="EN-US" style="line-height: 22px;">session</span><span style="line-height: 22px; font-family: 宋体;">重新协商之前总共读写的数据长度。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.8 BIO_new_ssl<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数使用</span><span lang="EN-US" style="line-height: 22px;">ctx</span><span style="line-height: 22px; font-family: 宋体;">参数所代表的</span><span lang="EN-US" style="line-height: 22px;">SSL_CTX</span><span style="line-height: 22px; font-family: 宋体;">结构创建一个</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，如果参数</span><span lang="EN-US" style="line-height: 22px;">client</span><span style="line-height: 22px; font-family: 宋体;">为非零值，就使用客户端模式。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.9 BIO_new_ssl_connect<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数创建一个包含</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的新</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链，并在后面附加了一个连接类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。方便而且有趣的是，因为在</span><span lang="EN-US" style="line-height: 22px;">filter</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">里，如果是该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">不知道（没有实现）</span><span lang="EN-US" style="line-height: 22px;">BIO_ctrl</span><span style="line-height: 22px; font-family: 宋体;">操作，它会自动把该操作传到下一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">进行调用，所以我们可以在调用本函数得到</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">上直接调用</span><span lang="EN-US" style="line-height: 22px;">BIO_set_host</span><span style="line-height: 22px; font-family: 宋体;">函数来设置服务器名字和端口，而不需要先找到连接</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.10 BIO_new_buffer_ssl_connect<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">创建一个包含</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，一个</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">以及一个连接类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.11 BIO_ssl_copy_session_id<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数将</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链</span><span lang="EN-US" style="line-height: 22px;">from</span><span style="line-height: 22px; font-family: 宋体;">的</span><span lang="EN-US" style="line-height: 22px;">SSL Session ID</span><span style="line-height: 22px; font-family: 宋体;">拷贝到</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链</span><span lang="EN-US" style="line-height: 22px;">to</span><span style="line-height: 22px; font-family: 宋体;">中。事实上，它是通过查找到两个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，然后调用</span><span lang="EN-US" style="line-height: 22px;">SSL_copy_session_id</span><span style="line-height: 22px; font-family: 宋体;">来完成操作的。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.12 BIO_ssl_shutdown<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数关闭一个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接。事实上，该函数通过查找到该</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，然后调用</span><span lang="EN-US" style="line-height: 22px;">SSL_shutdown</span><span style="line-height: 22px; font-family: 宋体;">函数关闭其内部的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">指针。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><h3 style="line-height: 25px; margin-top: 0px; margin-right: 0px; margin-bottom: 0px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 25px;">24.13 BIO_do_handshake<o p style="line-height: 25px;"></o:p></span></h3><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">该函数在相关的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">上启动</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">握手过程并建立</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接。连接成功建立返回</span><span lang="EN-US" style="line-height: 22px;">1</span><span style="line-height: 22px; font-family: 宋体;">，否则返回</span><span lang="EN-US" style="line-height: 22px;">0</span><span style="line-height: 22px; font-family: 宋体;">或负值，如果连接</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">是非阻塞型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，此时可以调用</span><span lang="EN-US" style="line-height: 22px;">BIO_should_retry</span><span style="line-height: 22px; font-family: 宋体;">函数以决定释放需要重试。如果调用该函数的时候</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接已经建立了，那么该函数不会做任何事情。一般情况下，应用程序不需要直接调用本函数，除非你希望将握手过程跟其它</span><span lang="EN-US" style="line-height: 22px;">IO</span><span style="line-height: 22px; font-family: 宋体;">操作分离开来。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">需要注意的是，如果底层是阻塞型（</span><span lang="EN-US" style="line-height: 22px;">openssl</span><span style="line-height: 22px; font-family: 宋体;">帮助文档写的是非阻塞型</span><span lang="EN-US" style="line-height: 22px;">,non blocking,</span><span style="line-height: 22px; font-family: 宋体;">但是根据上下文意思已经</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">的其它性质，我个人认为是阻塞型，</span><span lang="EN-US" style="line-height: 22px;">blocking</span><span style="line-height: 22px; font-family: 宋体;">才是正确的）的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，在一些意外的情况</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">下也会发出意外的重试请求，如在执行</span><span lang="EN-US" style="line-height: 22px;">BIO_read</span><span style="line-height: 22px; font-family: 宋体;">操作的时候如果启动了</span><span lang="EN-US" style="line-height: 22px;">session</span><span style="line-height: 22px; font-family: 宋体;">重新协商的过程就会发生这种情况。在</span><st1 chsdate isrocdate="False" islunardate="False" day="30" month="12" year="1899" wst="on" style="line-height: 22px;"><span lang="EN-US" style="line-height: 22px;">0.9.6</span></st1:chsdate><span style="line-height: 22px; font-family: 宋体;">和以后的版本，可以通过</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">的标志</span><span lang="EN-US" style="line-height: 22px;">SSL_AUTO_RETRY</span><span style="line-height: 22px; font-family: 宋体;">将该类行为禁止，这样设置之后，使用阻塞型传输的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">就永远不会发出重试的请求。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span style="line-height: 22px; font-family: 宋体;">例子</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">1.</span><span style="line-height: 22px; font-family: 宋体;">一个</span><span lang="EN-US" style="line-height: 22px;">SSL/TLS</span><span style="line-height: 22px; font-family: 宋体;">客户端的例子，完成从一个</span><span lang="EN-US" style="line-height: 22px;">SSL/TLS</span><span style="line-height: 22px; font-family: 宋体;">服务器返回一个页面的功能。其中</span><span lang="EN-US" style="line-height: 22px;">IO</span><span style="line-height: 22px; font-family: 宋体;">操作的方法跟连接类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">里面的例子是相同的。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *sbio, *out;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int len;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char tmpbuf[1024];<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">SSL_CTX *ctx;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">SSL *ssl;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_load_crypto_strings();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_load_SSL_strings();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">OpenSSL_add_all_algorithms();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">//</span><span style="line-height: 22px; font-family: 宋体;">如果系统平台不支持自动进行随机数种子的设置，这里应该进行设置</span><span lang="EN-US" style="line-height: 22px;">(seed PRNG)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ctx = SSL_CTX_new(SSLv23_client_method());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">//</span><span style="line-height: 22px; font-family: 宋体;">通常应该在这里设置一些验证路径和模式等，因为这里没有设置，所以该例子可以跟使用任意</span><span lang="EN-US" style="line-height: 22px;">CA</span><span style="line-height: 22px; font-family: 宋体;">签发证书的任意服务器建立连接</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">sbio = BIO_new_ssl_connect(ctx);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_get_ssl(sbio, &amp;ssl);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{fprintf(stderr, "Can't locate SSL pointer\n");}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">不需要任何重试请求</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">SSL_set_mode(ssl, SSL_MODE_AUTO_RETRY);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">//</span><span style="line-height: 22px; font-family: 宋体;">这里你可以添加对</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">的其它一些设置</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_set_conn_hostname(sbio, "localhost:https");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">out = BIO_new_fp(stdout, BIO_NOCLOSE);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error connecting to server\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error establishing SSL connection\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">这里可以添加检测</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">连接的代码，得到一些连接信息</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(sbio, "GET / HTTP/1.0\n\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">for(;;)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">len = BIO_read(sbio, tmpbuf, 1024);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> break;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_write(out, tmpbuf, len);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free_all(sbio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free(out);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">2.</span><span style="line-height: 22px; font-family: 宋体;">一个简单的服务器的例子。它使用了</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，从而可以使用</span><span lang="EN-US" style="line-height: 22px;">BIO_gets</span><span style="line-height: 22px; font-family: 宋体;">从一个</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">读取数据。它创建了一个包含客户端请求的随机</span><span lang="EN-US" style="line-height: 22px;">web</span><span style="line-height: 22px; font-family: 宋体;">页，并把请求信息输出到标准输出设备。</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO *sbio, *bbio, *acpt, *out;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">int len;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">char tmpbuf[1024];<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">SSL_CTX *ctx;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">SSL *ssl;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_load_crypto_strings();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_load_SSL_strings();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">OpenSSL_add_all_algorithms();<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">//</span><span style="line-height: 22px; font-family: 宋体;">可能需要进行随机数的种子处理（</span><span lang="EN-US" style="line-height: 22px;">seed PRNG</span><span style="line-height: 22px; font-family: 宋体;">）</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ctx = SSL_CTX_new(SSLv23_server_method());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">if ( !SSL_CTX_use_certificate_file ( ctx, "server.pem", SSL_FILETYPE_PEM ) || !SSL_CTX_use_PrivateKey_file ( ctx, "server.pem", SSL_FILETYPE_PEM ) || !SSL_CTX_check_private_key(ctx))<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 0px; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error setting up SSL_CTX\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">return 0;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">//</span><span style="line-height: 22px; font-family: 宋体;">可以在这里设置验证路径，</span><span lang="EN-US" style="line-height: 22px;">DH</span><span style="line-height: 22px; font-family: 宋体;">和</span><span lang="EN-US" style="line-height: 22px;">DSA</span><span style="line-height: 22px; font-family: 宋体;">算法的临时密钥回调函数等等</span><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">创建一个新的服务器模式的</span><span lang="EN-US" style="line-height: 22px;">SSL</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">sbio=BIO_new_ssl(ctx,0);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_get_ssl(sbio, &amp;ssl);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;"><o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{fprintf(stderr, "Can't locate SSL pointer\n");}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">不需要任何重试请求</span><span lang="EN-US" style="line-height: 22px;">&nbsp;*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">SSL_set_mode(ssl, SSL_MODE_AUTO_RETRY);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">创建一个</span><span lang="EN-US" style="line-height: 22px;">Buffer</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">bbio = BIO_new(BIO_f_buffer());<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">加到</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链上</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">sbio = BIO_push(bbio, sbio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">acpt=BIO_new_accept("4433");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*</span><span style="line-height: 22px; font-family: 宋体;">当一个新连接建立的时候，我们可以将</span><span lang="EN-US" style="line-height: 22px;">sbio</span><span style="line-height: 22px; font-family: 宋体;">链自动插入到连接所在的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链中去。这时候，这个</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">链</span><span lang="EN-US" style="line-height: 22px;">(sbio)</span><span style="line-height: 22px; font-family: 宋体;">就被</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">吞并了，并且当</span><span lang="EN-US" style="line-height: 22px;">accept</span><span style="line-height: 22px; font-family: 宋体;">类型</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">释放的时候，它会自动被释放。</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_set_accept_bios(acpt,sbio);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">out = BIO_new_fp(stdout, BIO_NOCLOSE);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">设置</span><span lang="EN-US" style="line-height: 22px;">&nbsp;accept BIO */<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error setting up accept BIO\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">return 0;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">等待连接的建立</span><span lang="EN-US" style="line-height: 22px;">&nbsp;*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error in connection\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">return 0;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*</span><span style="line-height: 22px; font-family: 宋体;">因为我们只想处理一个连接，所以可以删除和释放</span><span lang="EN-US" style="line-height: 22px;">&nbsp;accept BIO</span><span style="line-height: 22px; font-family: 宋体;">了</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">sbio = BIO_pop(acpt);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_free_all(acpt);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;"> &lt;= 0)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">fprintf(stderr, "Error in SSL handshake\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">ERR_print_errors_fp(stderr);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">return 0;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(sbio, "HTTP/1.0 200 OK\r\nContent-type: text/html\r\n\r\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(sbio, "&lt;pre&gt;\r\nConnection Established\r\nRequest headers:\r\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(sbio, "--------------------------------------------------\r\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">for(;;)<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">{<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">len = BIO_gets(sbio, tmpbuf, 1024);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> break;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_write(sbio, tmpbuf, len);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">BIO_write(out, tmpbuf, len);<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">查找请求头的结束标准空白行</span><span lang="EN-US" style="line-height: 22px;">*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px; text-indent: 21pt;"><span lang="EN-US" style="line-height: 22px;"> || (tmpbuf[0] == '\n')) break;<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">}<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(sbio, "--------------------------------------------------\r\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_puts(sbio, "&lt;/pre&gt;\r\n");<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">/*&nbsp;</span><span style="line-height: 22px; font-family: 宋体;">因为使用了</span><span lang="EN-US" style="line-height: 22px;">buffer</span><span style="line-height: 22px; font-family: 宋体;">类型的</span><span lang="EN-US" style="line-height: 22px;">BIO</span><span style="line-height: 22px; font-family: 宋体;">，我们最好调用</span><span lang="EN-US" style="line-height: 22px;">BIO_flush</span><span style="line-height: 22px; font-family: 宋体;">函数</span><span lang="EN-US" style="line-height: 22px;">&nbsp;*/<o p style="line-height: 22px;"></o:p></span></p><p style="line-height: 22px; margin-top: 0px; margin-right: 0px; margin-bottom: 10px; margin-left: 21pt; padding-top: 0px; padding-right: 0px; padding-bottom: 0px; padding-left: 0px;"><span lang="EN-US" style="line-height: 22px;">BIO_flush(sbio);<o p style="line-height: 22px;"></o:p></span></p><span lang="EN-US" style="line-height: 22px; font-size: 10.5pt; font-family: 'Times New Roman', serif;">BIO_free_all(sbio);</span></span></h2>
</body></html>