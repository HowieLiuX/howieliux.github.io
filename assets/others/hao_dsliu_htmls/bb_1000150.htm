<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：九.输入/输出保护</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>九.输入/输出保护</h2>
<p align="right">发布时间：2012-5-27 17:21
<br>分类名称：80x86保护模式</p><br>
<p><span style="color:black; font-size:9pt;"  ><span style="font-family:Batang;"  >为了支持多任务，80386不仅要有效地实现任务隔离，而且还要有效地控制各任务的输入/输出， 避免输入/输出冲突。本文将介绍输入输出保护。</span><span style="font-family:宋体;"  >&nbsp;</span><span style="color:blue; font-family:Batang;"  ><span style="text-decoration:underline;"  >这里下载本文源代码</span><span style="color:black;"  >。 </span></span></span></p><p><span style="color:black; font-family:Batang; font-size:18pt;"  ><strong>&lt;一&gt;输入/输出保护 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >80386采用I/O特权级IPOL和I/O许可位图的方法来控制输入/输出，实现输入/输出保护。 </span></p><p><span style="color:black; font-family:Batang; font-size:13pt;"  ><strong>1.I/O敏感指令 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >输入输出特权级(I/O Privilege Level)规定了可以执行所有与I/O相关的指令和访问I/O空间中 所有地址的最外层特权级。IOPL的值在如下图所示的标志寄存器中。 </span></p><p> &nbsp;</p><div style="text-align: center;"  ><table style="border-collapse:collapse; background: #0099cc;"  border="0"  ><colgroup><col style="width:46px;"  /><col style="width:77px;"  /><col style="width:30px;"  /><col style="width:30px;"  /><col style="width:30px;"  /><col style="width:30px;"  /><col style="width:30px;"  /><col style="width:30px;"  /><col style="width:30px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><col style="width:25px;"  /><tbody valign="top"  ><tr><td rowspan="2"  vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >标&nbsp;&nbsp;志<br>寄存器</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT31—BIT18</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT17</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT16</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT15</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT14</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT13—BIT12</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT11</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT10</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT9</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT8</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT7</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT6</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT5</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT4</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT3</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT2</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT1</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >BIT0</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >00000000000000</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >V<br>M</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >R<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >0</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >N<br>T</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >IOPL</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >OF</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >D<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >I<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >T<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >S<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >Z<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >0</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >A<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >0</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >P<br>F</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >1</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >C<br>F</span></p></td></tr></table></div><p> &nbsp;</p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >I/O许可位图规定了I/O空间中的哪些地址可以由在任何特权级执行的程序所访问。I/O许可位图 在任务状态段TSS中。 </span></p><p> &nbsp;</p><div style="text-align: center;"  ><table style="border-collapse:collapse; background: #0099cc;"  border="0"  ><colgroup><col style="width:73px;"  /><col style="width:28px;"  /><col style="width:124px;"  /><col style="width:145px;"  /><tbody valign="top"  ><tr><td rowspan="7"  vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >I/O敏感指令</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >指令</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >功能</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >保护方式下的执行条件</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CLI</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >清除EFLAGS中的IF位</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL&lt;=IOPL</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >STI</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >设置EFLAGS中的IF位</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL&lt;=IOPL</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >IN</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >从I/O地址读出数据</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL&lt;=IOPL或I/O位图许可</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >INS</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >从I/O地址读出字符串</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL&lt;=IOPL或I/O位图许可</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >OUT</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >向I/O地址写数据</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL&lt;=IOPL或I/O位图许可</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >OUTS</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >向I/O地址写字符串</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL&lt;=IOPL或I/O位图许可</span></p></td></tr></table></div><p> &nbsp;</p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >上表所列指令称为I/O敏感指令，由于这些指令与I/O有关，并且只有在满足所列条件时才可以执行， 所以把它们称为I/O敏感指令。从表中可见，当前特权级不在I/O特权级外层时，可以正常执行所列的 全部I/O敏感指令；当特权级在I/O特权级外层时，执行CLI和STI指令将引起通用保护异常，而其它四 条指令是否能够被执行要根据访问的I/O地址及I/O许可位图情况而定(在下面论述)，如果条件不满足 而执行，那么将引起出错码为0的通用保护异常。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >由于每个任务使用各自的EFLAGS值和拥有自己的TSS，所以每个任务可以有不同的IOPL，并且可以定 义不同的I/O许可位图。注意，这些I/O敏感指令在实模式下总是可执行的。 </span></p><p><span style="color:black; font-family:Batang; font-size:13pt;"  ><strong>2.I/O许可位图 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >如果只用IOPL限制I/O指令的执行是很不方便的，不能满足实际要求需要。因为这样做会使得在特权 级3执行的应用程序要么可访问所有I/O地址，要么不可访问所有I/O地址。实际需要与此刚好相反， 只允许任务甲的应用程序访问部分I/O地址，只允许任务乙的应用程序访问另一部分I/O地址，以避免 任务甲和任务乙在访问I/O地址时发生冲突，从而避免任务甲和任务乙使用使用独享设备时发生冲突。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >因此，在IOPL的基础上又采用了I/O许可位图。I/O许可位图由二进制位串组成。位串中的每一位依次 对应一个I/O地址，位串的第0位对应I/O地址0，位串的第n位对应I/O地址n。如果位串中的第位为0， 那么对应的I/O地址m可以由在任何特权级执行的程序访问；否则对应的I/O地址m只能由在IOPL特权级 或更内层特权级执行的程序访问。如果在I/O外层特权级执行的程序访问位串中位值为1的位所对应 的I/O地址，那么将引起通用保护异常。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >I/O地址空间按字节进行编址。一条I/O指令最多可涉及四个I/O地址。在需要根据I/O位图决定是否可 访问I/O地址的情况下，当一条I/O指令涉及多个I/O地址时，只有这多个I/O地址所对应的I/O许可位 图中的位都为0时，该I/O指令才能被正常执行，如果对应位中任一位为1，就会引起通用保护异常。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >80386支持的I/O地址空间大小是64K，所以构成I/O许可位图的二进制位串最大长度是64K个位，即位图 的有效部分最大为8K字节。一个任务实际需要使用的I/O许可位图大小通常要远小于这个数目。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >当前任务使用的I/O许可位图存储在当前任务TSS中低端的64K字节内。I/O许可位图总以字节为单位 存储，所以位串所含的位数总被认为是8的倍数。从前文中所述的TSS格式可见，TSS内偏移66H的字 确定I/O许可位图的开始偏移。由于I/O许可位图最长可达8K字节，所以开始偏移应小于56K，但必须 大于等于104，因为TSS中前104字节为TSS的固定格式，用于保存任务的状态。 </span></p><p><span style="color:black; font-family:Batang; font-size:13pt;"  ><strong>1.I/O访问许可检查细节 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >保护模式下处理器在执行I/O指令时进行许可检查的细节如下所示。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(1)若CPL&lt;=IOPL，则直接转步骤(8)； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(2)取得I/O位图开始偏移； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(3)计算I/O地址对应位所在字节在I/O许可位图内的偏移； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(4)计算位偏移以形成屏蔽码值，即计算I/O地址对应位在字节中的第几位； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(5)把字节偏移加上位图开始偏移，再加1，所得值与TSS界限比较，若越界，则产生出错码 为0的通用保护故障； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(6)若不越界，则从位图中读对应字节及下一个字节； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(7)把读出的两个字节与屏蔽码进行与运算，若结果不为0表示检查未通过，则产生出错码 为0的通用保护故障； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(8)进行I/O访问。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >设某一任务的TSS段如下： </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TSSSEG                  SEGMENT PARA USE16 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        TSS     &lt;&gt;             <em>;TSS低端固定格式部分</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        DB      8 DUP(0)       <em>;对应I/O端口00H—3FH</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        DB      10000000B      <em>;对应I/O端口40H—47H</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        DB      01100000B      <em>;对用I/O端口48H—4FH</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        DB      8182 DUP(0ffH) <em>;对应I/O端口50H—0FFFFH</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        DB      0FFH           <em>;位图结束字节</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TSSLen                  =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TSSSEG                  ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >再假设IOPL=1，CPL=3。那么如下I/O指令有些能正常执行，有些会引起通用保护异常： </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        in      al,21h  <em>;(1)正常执行</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        in      al,47h  <em>;(2)引起异常</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        out     20h,al  <em>;(3)正常实行</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        out     4eh,al  <em>;(4)引起异常</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        in      al,20h  <em>;(5)正常执行</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        out     20h,eax <em>;(6)正常执行</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        out     4ch,ax  <em>;(7)引起异常</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        in      ax,46h  <em>;(8)引起异常</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                        in      eax,42h <em>;(9)正常执行</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >由上述I/O许可检查的细节可见，不论是否必要，当进行许可位检查时，80386总是从I/O许可位图 中读取两个字节。目的是为了尽快地执行I/O许可检查。一方面，常常要读取I/O许可位图的两个字 节。例如，上面的第(8)条指令要对I/O位图中的两个位进行检查，其低位是某个字节的最高位，高 位是下一个字节的最低位。可见即使只要检查两个位，也可能需要读取两个字节。另一方面，最多 检查四个连续的位，即最多也只需读取两个字节。所以每次要读取两个字节。这也是在判别是否越 界时再加1的原因。为此，为了避免在读取I/O许可位图的最高字节时产生越界，必须在I/O许可位 图的最后填加一个全1的字节，即0FFH。此全1的字节应填加在最后一个位图字节之后，TSS界限范 围之前，即让填加的全1字节在TSS界限之内。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >I/O许可位图开始偏移加8K所得的值与TSS界限值二者中较小的值决定I/O许可位图的末端。当TSS的 界限大于I/O许可位图开始偏移加8K时，I/O许可位图的有效部分就有8K字节，I/O许可检查全部根 据全部根据该位图进行。当TSS的界限不大于I/O许可位图开始偏移加8K时，I/O许可位图有效部分 就不到8K字节，于是对较小I/O地址访问的许可检查根据位图进行，而对较大I/O地址访问的许可检 查总被认为不可访问而引起通用保护故障。因为这时会发生字节越界而引起通用保护异常，所以在 这种情况下，可认为不足的I/O许可位图的高端部分全为1。利用这个特点，可大大节约TSS中I/O许 可位图占用的存储单元，也就大大减小了TSS段的长度。 </span></p><p><span style="color:black; font-family:Batang; font-size:18pt;"  ><strong>&lt;二&gt;重要标志保护 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >输入输出的保护与存储在标志寄存器EFLAGS中的IOPL密切相关，显然不能允许随便地改变IOPL，否 则就不能有效地实现输入输出保护。类似地，对EFLAGS中的IF位也必须加以保护，否则CLI和STI作 为敏感指令对待是无意义的。此外，EFLAGS中的VM位决定着处理器是否按虚拟8086方式工作。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >80386对EFLAGS中的这三个字段的处理比较特殊，只有在较高特权级执行的程序才能执 行IRET、POPF、CLI和STI等指令改变它们。下表列出了不同特权级下对这三个字段的处理情况。 </span></p><p> &nbsp;</p><div style="text-align: center;"  ><table style="border-collapse:collapse; background: #0099cc;"  border="0"  ><colgroup><col style="width:76px;"  /><col style="width:196px;"  /><col style="width:118px;"  /><col style="width:79px;"  /><col style="width:67px;"  /><tbody valign="top"  ><tr><td rowspan="4"  vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >不同特权级对<br>标志寄存器特<br>殊字段的处理</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >特权级</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >VM标志字段</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >IOPL标志字段</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  solid #00ccff 0.75pt; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >IF标志字段</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL=0</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >可变(初POPF指令外)</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >可变</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >可变</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >0&lt;cpl&lt;=iopl&lt; td=""&gt;&lt;/cpl&lt;=iopl&lt;&gt;</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >不变</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >不变</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >可变</span></p></td></tr><tr><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  solid #00ccff 0.75pt; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p><span style="color:black; font-family:宋体; font-size:9pt;"  >CPL&gt;IOPL</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >不变</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >不变</span></p></td><td vAlign="middle"  style="padding-top: 1px; padding-left: 1px; padding-bottom: 1px; padding-right: 1px; border-top:  none; border-left:  none; border-bottom:  solid #006699 0.75pt; border-right:  solid #006699 0.75pt;"  ><p style="text-align: center;"  ><span style="color:black; font-family:宋体; font-size:9pt;"  >不变</span></p></td></tr></table></div><p> &nbsp;</p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >从表中可见，只有在特权级0执行的程序才可以修改IOPL位及VM位；只能由相对于IOPL同级或更内 层特权级执行的程序才可以修改IF位。与CLI和STI指令不同，在特权级不满足上述条件的情况下， 当执行POPF指令和IRET指令时，如果试图修改这些字段中的任何一个字段，并不引起异常，但试图 要修改的字段也未被修改，也不给出任何特别的信息。此外，指令POPF总不能改变VM位，而PUSHF指 令所压入的标志中的VM位总为0。 </span></p><p><span style="color:black; font-family:Batang; font-size:18pt;"  ><strong>&lt;三&gt;演示输入输出保护的实例(实例九) </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >下面给出一个用于演示输入输出保护的实例。演示内容包括：I/O许可位图的作用、I/O敏感指令 引起的异常和特权指令引起的异常；使用段间调用指令CALL通过任务门调用任务，实现任务嵌套。 </span></p><p><span style="color:black; font-family:Batang; font-size:13pt;"  ><strong>1.演示步骤 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >实例演示的内容比较丰富，具体演示步骤如下： </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(1)在实模式下做必要准备后，切换到保护模式； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(2)进入保护模式的临时代码段后，把演示任务的TSS段描述符装入TR，并设置演示任务 的堆栈； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(3)进入演示代码段，演示代码段的特权级是0； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(4)通过任务门调用测试任务1。测试任务1能够顺利进行； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(5)通过任务门调用测试任务2。测试任务2演示由于违反I/O许可位图规定而导致通用保 护异常； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(6)通过任务门调用测试任务3。测试任务3演示I/O敏感指令如何引起通用保护异常； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(7)通过任务门调用测试任务4。测试任务4演示特权指令如何引起通用保护异常； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(8)从演示代码转临时代码，准备返回实模式； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(9)返回实模式，并作结束处理。 </span></p><p><span style="color:black; font-family:Batang; font-size:13pt;"  ><strong>2.源程序组织和清单 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >为了达到演示目的，实例除了演示任务外，还涉及四个测试任务和一个通用保护故障处理任务。 实例由如下几部分组成。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(1)全局描述符表GDT和中断描述符表IDT； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(2)其它中断/异常处理程序代码段； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(3)通用保护故障处理任务的任务状态段、堆栈段和代码段； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(4)四个测试任务合用的任务状态段、堆栈段和代码段； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(5)演示任务的任务状态段、堆栈段和代码段； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(6)演示任务的临时代码段； </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >(7)实模式下执行的启动与结束程序代码段和数据段。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >实例九源程序清单如下： </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;名称:ASM9.ASM</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;功能:演示I/O保护及I/O敏感指令的作用</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;编译:TASM ASM9.ASM</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;连接:TLINK /32 ASM9.OBJ</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >INCLUDE         386SCD.INC </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GDTSeg          SEGMENT PARA USE16                <em>;全局描述符表段(16位)</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GDT             LABEL   BYTE </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;空描述符</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DUMMY           Desc    &lt;&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;规范段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Normal          Desc    &lt;0ffffh,,,ATDW,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Normal_Sel      =       Normal-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;视频缓冲区段描述符(DPL=3)及选择子(任何特权级可写)</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >VideoBuf        Desc    &lt;07fffh,8000h,0bh,ATDW,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >VideoBuf_Sel    =       VideoBuf-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >EFFGDT          LABEL   BYTE </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;演示任务TSS段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoTSS         Desc    &lt;DemoTSSLen-1,DemoTSSSeg,,AT386TSS,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoTSS_Sel     =       DemoTSS-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;演示任务堆栈段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoStack       Desc    &lt;DemoStackLen-1,DemoStackSeg,,ATDW,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoStack_Sel   =       DemoStack-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;演示代码段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoCode        Desc    &lt;DemoCodeLen-1,DemoCodeSeg,,ATCE,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoCode_Sel    =       DemoCode-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;属于演示任务的临时代码段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TempCode        Desc    &lt;0ffffh,TempCodeSeg,,ATCE,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TempCode_Sel    =       TempCode-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;指向GDT的存储段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ToGDT           Desc    &lt;GDTLen-1,GDTSeg,,ATDW,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ToGDT_Sel       =       ToGDT-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;指向通用保护故障处理任务TSS的存储段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ToGPTSS         Desc    &lt;GPTSSLen-1,GPTSSSeg,,ATDW,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ToGPTSS_Sel     =       ToGPTSS-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;指向测试任务TSS的存储段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ToTestTSS       Desc    &lt;TestTSSLen-1,TestTSSSeg,,ATDW,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ToTestTSS_Sel   =       ToTestTSS-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;测试任务TSS段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestTSS         Desc    &lt;TestTSSLen-1,TestTSSSeg,,AT386TSS,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestTSS_Sel     =       TestTSS-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;测试任务1堆栈段描述符(DPL=1)及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test1Stack      Desc    &lt;TestStackLen-1,TestStackSeg,,ATDW+DPL1,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test1Stack_Sel  =       Test1Stack-GDT+RPL1 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;测试任务1代码段描述符(DPL=1)及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test1Code       Desc    &lt;TestCodeLen-1,TestCodeSeg,,ATCE+DPL1,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test1Code_Sel   =       Test1Code-GDT+RPL1 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;测试任务2堆栈段描述符(DPL=2)及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test2Stack      Desc    &lt;TestStackLen-1,TestStackSeg,,ATDW+DPL2,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test2Stack_Sel  =       Test2Stack-GDT+RPL2 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;测试任务2代码段描述符(DPL=2)及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test2Code       Desc    &lt;TestCodeLen-1,TestCodeSeg,,ATCE+DPL2,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test2Code_Sel   =       Test2Code-GDT+RPL2 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;测试任务3堆栈段描述符(DPL=3)及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test3Stack      Desc    &lt;TestStackLen-1,TestStackSeg,,ATDW+DPL3,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test3Stack_Sel  =       Test3Stack-GDT+RPL3 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;测试任务3代码段描述符(DPL=3)及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test3Code       Desc    &lt;TestCodeLen-1,TestCodeSeg,,ATCE+DPL3,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test3Code_Sel   =       Test3Code-GDT+RPL3 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;通用保护故障处理任务的TSS段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPTSS           Desc    &lt;GPTSSLen-1,GPTSSSeg,,AT386TSS,,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPTSS_Sel       =       GPTSS-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;通用保护故障处理任务的堆栈段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPStack         Desc    &lt;GPStackLen-1,GPStackSeg,,ATDW,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPStack_Sel     =       GPStack-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;通用保护故障处理任务的代码段描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPCode          Desc    &lt;GPCodeLen-1,GPCodeSeg,,ATCE,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPCode_Sel      =       GPCode-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;其它中断或异常处理程序代码段(一致可读)描述符及选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrCode         Desc    &lt;ErrCodeLen-1,ErrCodeSeg,,ATCCOR,D32,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrCode_Sel     =       ErrCode-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GDNum           =       ($-EFFGDT)/(SIZE Desc)    <em>;需处理基地址的描述符个数</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;指向测试任务的任务门</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestTask        Gate    &lt;,TestTSS_Sel,,ATTaskGate,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test_Sel        =       TestTask-GDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GDTLen          =       $-GDT                     <em>;全局描述符表长度</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GDTSeg          ENDS                              <em>;全局描述符表段定义结束</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >IDTSeg          SEGMENT PARA USE16                <em>;中断描述符表段(16位)</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >IDT             LABEL   BYTE                      <em>;中断描述符表</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                REPT    13 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                Gate    &lt;ErrBegin,ErrCode_Sel,,AT386TGate,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ENDM </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                Gate    &lt;,GPTSS_Sel,,ATTaskGate,&gt; <em>;通用故障处理程序门描述符</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                REPT    242 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                Gate    &lt;ErrBegin,ErrCode_Sel,,AT386TGate,&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ENDM </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >IDTLen          =       $-IDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >IDTSeg          ENDS                              <em>;中断描述符表段定义结束</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;其它中断或异常处理程序的代码段(一致可读)</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrCodeSeg      SEGMENT PARA USE32 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ASSUME  CS:ErrCodeSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrMess         DB      'Error!!!' </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrMessLen      =       $-ErrMess </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrBegin        PROC    FAR </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                cld </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,ErrCode_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ds,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                lea     esi,ErrMess </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,VideoBuf_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     es,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     edi,1992 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ecx,ErrMessLen </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ah,4eh </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Err1:           lodsb </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                stosw </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                loop    Err1 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                jmp     $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrBegin        ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrCodeLen      =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ErrCodeSeg      ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPTSSSeg        SEGMENT PARA USE16                <em>;通用保护故障处理任务的TSS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPTaskSS        LABEL   BYTE </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;任务嵌套时的链接指针</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;0级堆栈偏移</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      0,0                       <em>;0级堆栈选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;1级堆栈偏移</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      0,0                       <em>;1级堆栈选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;2级堆栈偏移</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      0,0                       <em>;2级堆栈选择子</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;CR3</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      GPBegin,0                 <em>;EIP</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;EFLAGS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;EAX</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;ECX</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;EDX</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;EBX</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      GPStackLen                <em>;ESP</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;EBP</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;ESI</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DD      0                         <em>;EDI</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      VideoBuf_Sel,0            <em>;ES</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      GPCode_Sel,0              <em>;CS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      GPStack_Sel,0             <em>;SS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      ToTestTSS_Sel,0           <em>;DS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      ToGPTSS_Sel,0             <em>;FS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      0,0                       <em>;GS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      0,0                       <em>;LDTR</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      0                         <em>;调试陷阱标志</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DW      $+2                       <em>;指向I/O许可位图的偏移</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      0ffh                      <em>;I/O许可位图结束标志</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPTSSLen        =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPTSSSeg        ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPStackSeg      SEGMENT PARA USE32                <em>;通用保护故障处理任务堆栈段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPStackLen      =       512 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      GPStackLen DUP(0) </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPStackSeg      ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;通用保护故障处理程序代码段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPCodeSeg       SEGMENT PARA USE32 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ASSUME  CS:GPCodeSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPBegin         PROC    FAR </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;在屏幕左上角显示故障点</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                xor     edi,edi </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ebx,OFFSET TestTaskSS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     edx,DWORD PTR [ebx].TRCS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                call    EchoEDX </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,(17h SHL 8)+':' </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                stosw </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     edx,[ebx].TREIP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                call    EchoEDX </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;演示以便看清故障点</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ecx,1234567h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                loop    $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;调整任务链接指针,中止故障任务</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ebx,OFFSET GPTaskSS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,DemoTSS_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     fs:[ebx].TRLink,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                add     esp,4 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                iretd </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                jmp     GPBegin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPBegin         ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;显示edx内容的子程序</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >EchoEDX         PROC </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ah,17h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ecx,8 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >EchoEDX1:       rol     edx,4 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     al,dl </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                call    HToASCII </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                stosw </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                loop    EchoEDX1 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ret </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >EchoEDX         ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;把4位二进制数转换成对应的ASCII码</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >HToASCII        PROC </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                and     al,0fh </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                add     al,90h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                daa </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                adc     al,40h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                daa </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ret </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >HToASCII        ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPCodeLen       =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >GPCodeSeg       ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;测试任务的TSS段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestTSSSeg      SEGMENT PARA USE16 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestTaskSS      TSS     &lt;&gt;                        <em>;TSS的固定格式部分</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >IOMap           LABEL   BYTE                      <em>;I/O许可位图</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      8 DUP(0ffh)               <em>;端口00h--3fh</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      11111011b                 <em>;端口40h--47h</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      3 DUP(0ffh)               <em>;端口48h--5fh</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      11111101b                 <em>;端口60h--67h</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      0                         <em>;端口68h--6fh</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      0ffh                      <em>;I/O许可位图结束标志</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestTSSLen      =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestTSSSeg      ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;测试任务的堆栈段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestStackSeg    SEGMENT PARA USE32 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestStackLen    =       1024 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      TestStackLen DUP(0) </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestStackSeg    ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;测试任务的代码段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestCodeSeg     SEGMENT PARA USE32 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ASSUME  CS:TestCodeSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test3Begin      PROC    FAR </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                cli                               <em>;I/O敏感指令</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                clts                              <em>;特权指令</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                iretd </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                jmp     Test3Begin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Test3Begin      ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestBegin       PROC    FAR </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     al,0b6h                   <em>;使扬声器发出一长声</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                out     43h,al </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     al,2 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                out     42h,al </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     al,34h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                out     42h,al </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                in      al,61h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ah,al </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                or      al,3 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                out     61h,al </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ecx,1234567h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                loop    $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     al,ah </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                out     61h,al </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                iretd </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                jmp     TestBegin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestBegin       ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestCodeLen     =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TestCodeSeg     ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;演示任务TSS段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoTSSSeg      SEGMENT PARA USE16 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoTaskSS      TSS     &lt;&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      0ffh                      <em>;I/O许可位图结束字节</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoTSSLen      =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoTSSSeg      ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;演示任务的堆栈段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoStackSeg    SEGMENT PARA USE32 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoStackLen    =       1024 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                DB      DemoStackLen DUP(0) </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoStackSeg    ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;演示任务的代码段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoCodeSeg     SEGMENT PARA USE32 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ASSUME  CS:DemoCodeSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoBegin       PROC    FAR </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,ToTestTSS_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ds,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ebx,OFFSET TestTaskSS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;把测试任务1的入口点,堆栈指针和标志值(含IOPL)填入测试任务TSS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRSS,Test1Stack_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TRESP,TestStackLen </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRCS,Test1Code_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREIP,OFFSET TestBegin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREFLAG,IOPL1 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;通过任务门调用测试任务</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                CALL32  Test_Sel,0 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;把测试任务2的入口点,堆栈指针和标志值(含IOPL)填入测试任务TSS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRSS,Test2Stack_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TRESP,TestStackLen </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRCS,Test2Code_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREIP,OFFSET TestBegin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREFLAG,IOPL1 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;通过任务门调用测试任务</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                CALL32  Test_Sel,0 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;把测试任务TSS描述符内的属性置为"可用"</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,ToGDT_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     fs,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     fs:TestTSS.Attributes,AT386TSS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;把测试任务3的入口点,堆栈指针和标志值(含IOPL)填入测试任务TSS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRSS,Test3Stack_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TRESP,TestStackLen </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRCS,Test3Code_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREIP,OFFSET Test3Begin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREFLAG,IOPL2 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;通过任务门调用测试任务</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                CALL32  Test_Sel,0 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;把测试任务TSS描述符内的属性置为"可用"</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,ToGDT_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     fs,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     fs:TestTSS.Attributes,AT386TSS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;把测试任务4的入口点,堆栈指针和标志值(含IOPL)填入测试任务TSS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRSS,Test3Stack_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TRESP,TestStackLen </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [ebx].TRCS,Test3Code_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREIP,OFFSET Test3Begin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     DWORD PTR [ebx].TREFLAG,IOPL3 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;通过任务门调用测试任务</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                CALL32  Test_Sel,0 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                JUMP32  TempCode_Sel,&lt;OFFSET ToDOS&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoBegin       ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoCodeLen     =       $ </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >DemoCodeSeg     ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TempCodeSeg     SEGMENT PARA USE16                <em>;演示任务的临时代码段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ASSUME  CS:TempCodeSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Virtual         PROC    FAR </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;置数据段寄存器为空</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,0 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ds,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     es,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     fs,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     gs,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;置堆栈指针</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,DemoStack_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ss,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     esp,DemoStackLen </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;置任务寄存器</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,DemoTSS_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ltr     ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >    <em>;转演示代码段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                JUMP16  DemoCode_Sel,DemoBegin </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >ToDOS:          clts </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,Normal_Sel </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ds,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     es,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     fs,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     gs,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ss,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     eax,cr0 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                and     al,11111110b </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     cr0,eax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                JUMP16  &lt;SEG Real&gt;,&lt;OFFSET Real&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Virtual         ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >TempCodeSeg     ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;============================================================================</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >RDataSeg        SEGMENT PARA USE16                <em>;实方式数据段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >VGDTR           PDesc   &lt;GDTLen-1,&gt;               <em>;GDT伪描述符</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >VIDTR           PDesc   &lt;IDTLen-1,&gt;               <em>;IDT伪描述符</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >NORVIDTR        PDesc   &lt;3ffh,&gt;                   <em>;用于保存原IDTR值</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >SPVar           DW      ?                         <em>;用于保存实方式下的SP</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >SSVar           DW      ?                         <em>;用于保存实方式下的SS</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >RDataSeg        ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >RCodeSeg        SEGMENT PARA USE16                <em>;实方式代码段</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ASSUME  CS:RCodeSeg,DS:RDataSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Start           PROC </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,RDataSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ds,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                cld </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                call    InitGDT                   <em>;初始化全局描述符表GDT</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                call    InitIDT                   <em>;初始化中断描述符表IDT</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                lgdt    QWORD PTR VGDTR           <em>;装载GDTR</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     SSVar,ss                  <em>;保存堆栈指针</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     SPVar,sp </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                sidt    QWORD PTR NORVIDTR        <em>;保存IDTR</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                cli                               <em>;关中断</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                lidt    QWORD PTR VIDTR           <em>;装载IDTR</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     eax,cr0 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                or      al,1 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     cr0,eax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                JUMP16  &lt;TempCode_Sel&gt;,&lt;OFFSET Virtual&gt; </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Real:           mov     ax,RDataSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ds,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                lss     sp,DWORD PTR SPVar        <em>;又回到实方式</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                lidt    QWORD PTR NORVIDTR </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                sti </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,4c00h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                int     21h </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >Start           ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >InitGDT         PROC </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                push    ds </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,GDTSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ds,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     cx,GDNum </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     si,OFFSET EFFGDT </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >InitG:          mov     ax,[si].BaseL </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                movzx   eax,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                shl     eax,4 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                shld    edx,eax,16 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR [si].BaseL,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     BYTE PTR [si].BaseM,dl </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     BYTE PTR [si].BaseH,dh </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                add     si,SIZE Desc </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                loop    InitG </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                pop     ds </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     bx,16 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,GDTSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mul     bx </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR VGDTR.Base,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR VGDTR.Base+2,dx </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ret </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >InitGDT         ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >InitIDT         PROC </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     bx,16 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     ax,IDTSeg </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mul     bx </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR VIDTR.Base,ax </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                mov     WORD PTR VIDTR.Base+2,dx </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                ret </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >InitIDT         ENDP </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  ><em>;----------------------------------------------------------------------------</em>   </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >RCodeSeg        ENDS </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >                END     Start </span></p><p><span style="color:black; font-family:Batang; font-size:13pt;"  ><strong>3.关于实例九的说明 </strong></span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >为了节省篇幅，同时也反映任务状态段的作用，实例通过任务门调用的四个测试任务合用一个 任务状态段。从源程序可见，这种合用，实际上是串行的。先把测试任务1的入口点填入测试任 务状态段，同时填入堆栈指针，然后调用测试任务1。在测试任务1完成后，再填入测试任务2的 入口点，也填入堆栈指针，然后调用测试任务2。依次类推。 </span></p><p><span style="color:black; font-family:Batang; font-size:9pt;"  >通用保护故障处理程序作为一个独立的任务出现。再发生通用保护故障后，通用保护故障处理程 序在屏幕上显示故障点的选择子和偏移，然后通过调整存放在任务状态段内的任务连接指针的方 法，中止引起故障的测试任务。</span></p>
</body></html>