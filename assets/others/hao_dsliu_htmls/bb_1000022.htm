<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：How to decrypt an SSL or TLS session by using Wireshark</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>How to decrypt an SSL or TLS session by using Wireshark</h2>
<p align="right">发布时间：2015-12-30 18:04
<br>分类名称：SSL</p><br>
<p style="background: white;"   ><span style="color:#1f497d; font-size:12pt;"   >From:</span>
<a rel="nofollow" href="http://blogs.technet.com/b/nettracer/archive/2010/10/01/how-to-decrypt-an-ssl-or-tls-session-by-using-wireshark.aspx"   ><span style="font-size:12pt;"   >http://blogs.technet.com/b/nettracer/archive/2010/10/01/how-to-decrypt-an-ssl-or-tls-session-by-using-wireshark.aspx</span></a><span style="color:#1f497d; font-size:12pt;"   >
</span></p><p style="background: white;"   >
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >Hi there,</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >In this blog post, I would like to talk about decrypting SSL/TLS sessions by using Wireshark provided that you have access to the server certificate's private key. In some cases it may be quite useful to see what is exchanged under the hood of an SSL/TLS session from troubleshooting purposes. You'll find complete steps to do this on Windows systems. Even though there're a couple of documentations around (you can find the references at the end of the blog post), all steps from one document doesn't fully apply and you get stuck at some point. I tested the following steps a couple of times on a Windows 2008 server and it seems to be working fine.</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >Here are the details of the process:</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >First of all we'll need the following tools for that process: (At least I tested with these versions)</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><a rel="nofollow" href="http://www.wireshark.org/download.html"   ><span style="color:#1f497d; font-size:12pt;"   >http://www.wireshark.org/download.html</span></a><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >Wireshark -&gt; Version 1.2.8</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><a rel="nofollow" href="http://www.slproweb.com/products/Win32OpenSSL.html"   ><span style="color:#1f497d; font-size:12pt;"   >http://www.slproweb.com/products/Win32OpenSSL.html</span></a><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >(Win32 OpenSSL v1.0.0.a Light)</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >openssl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &nbsp; -&gt; 1.0.0a</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   ><strong>1) We first need to export the certificate that is used by the server side in SSL/TLS session with the following steps:</strong></span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >Note: The Certificate export wizard could be started by right clicking the related certificate from certificates mmc and selecting "All Tasks &gt; Export" option.</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img1.ph.126.net_6ufxY3yv4O1OeKeiNmrbVA==_6630503716235826550.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img2.ph.126.net_BWkcSy4WSRkPp662Fup_xA==_6631230493422785474.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img2.ph.126.net_WZCijklh9WIKjw7f8Qa0Sw==_6630301406096312291.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img2.ph.126.net_DKlzC6DTSoS2Jtb8oFmbkQ==_6631250284632063743.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img2.ph.126.net_Rlx34e8eUiasTDgAi3aMRQ==_6630503716235826551.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img1.ph.126.net_fBBUdQg3GRJAB5E3L7NwKQ==_6630603771794751997.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   ><strong>2) In the second stage, we'll need to convert the private key file in PKCS12 format to PEM format (which is used by Wireshark) in two stages by using the openssl tool:</strong></span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   ><strong>c:\OpenSSL-Win32\bin&gt;&nbsp;<span style="background-color:yellow;"   >openssl pkcs12 -nodes -in&nbsp;<em>iis.pfx</em>&nbsp;-out&nbsp;<em>key.pem</em>&nbsp;-nocerts -nodes</span></strong></span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >Enter Import Password: &lt;&lt;Password used when exporting the certificate in PKCS12 format&gt;&gt;</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   ><strong>c:\OpenSSL-Win32\bin&gt;&nbsp;<span style="background-color:yellow;"   >openssl rsa -in&nbsp;<em>key.pem</em>&nbsp;-out&nbsp;<em>keyout.pem</em></span></strong></span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >writing RSA key</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >=&gt; After the last command, the outfile "keyout.pem" should be seen in the following format:</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#c00000; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >-----BEGIN RSA PRIVATE KEY-----</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >jffewjlkfjelkjfewlkjfew.....</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >...</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >akfhakdfhsakfskahfksjhgkjsah</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#c00000; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >-----END RSA PRIVATE KEY-----</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   ><strong>3) Now we can use the private key file in Wireshark as given below:</strong></span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >Note: The following dialog box could be seen by first selecting Edit &gt; Preferences and then selecting "Protocols" from the left pane and selecting SSL at the left pane again:</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img2.ph.126.net_b5dVk2gGD9mjytkjeBBFXw==_6630130981794007754.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >&nbsp;
</span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >Notes:</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >-&nbsp;<span style="background-color:yellow;"   >172.17.1.1</span>&nbsp;is server IP address. This is the server using the certificate that we extracted the private key from.</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >-&nbsp;<span style="background-color:yellow;"   >443</span>&nbsp;is the TCP port at the server side.</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >-&nbsp;<span style="background-color:yellow;"   >http</span>&nbsp;is the protocol carried inside the SSL/TLS session</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >-&nbsp;<span style="background-color:yellow;"   >c:\tls\keyout.pem</span>&nbsp;is the name of the file which includes the converted private key</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >-&nbsp;<span style="background-color:yellow;"   >c:\tls\debug2.txt</span>&nbsp;is the name of the file which includes information about the decryption process</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   ><strong>4) Once all is ready, you can click "Apply" to start the decryption process. Wireshark will show you the packets in the given session in an unencrypted fashion. Here is the difference between the encrypted and unencrypted versions:</strong></span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >a) How it is seen before Wireshark decrypts SSL/TLS session:</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img2.ph.126.net_0IVFc5pZ7jfMujVN4YVHFg==_6630708225399398609.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >&nbsp;
</span></p><p style="background: white;"   ><span style="color:#1f497d;"   ><span style="font-size:12pt;"   >b) How it is seen after Wireshark decrypts SSL/TLS session:</span><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#2a2a2a;"   >&nbsp;<img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img1.ph.126.net_mMijVYvYtxGyh0aWAKQubw==_6630629060562197374.jpg"   alt=""   /><span style="font-family:Segoe UI; font-size:9pt;"   >&nbsp;
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#003366; font-family:Segoe UI;"   ><strong><span style="font-size:9pt;"   >5</span><span style="font-size:12pt;"   >) Since the private key of a certificate could be considered as a password, we couldn't ask for that from our&nbsp;customers given that you're troubleshooting&nbsp;a problem on behalf of your customers not for your environment&nbsp;. The following alternatives could be used in that case:</span></strong><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   ><strong>Note: It looks like a capture file decrypted by using the private key couldn't be saved as a different capture file in unencrypted format.</strong></span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >- After decrypting the traffic, we could examine it in a live meeting session where the customer shares his desktop</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >- The decrypted packets could be printed to a file from File &gt; Print option (by choosing the "<span style="background-color:yellow;"   >Output to file</span>" option)</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >- By right clicking one of the decrypted packets and selecting "<span style="background-color:yellow;"   >Follow SSL Stream</span>", we can save the session content to a text file. The following is an example of such a file created that way:</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><img title="How to decrypt an SSL or TLS session by using Wireshark - Howie - Dspace"   src="pic/img2.ph.126.net_ai7riTEZvjbJteQMurmg5A==_6631402017236708447.jpg"   alt=""   /><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >&nbsp;
</span></p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   ><strong>6) More information could be found at the following links:</strong></span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >Citrix</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><a rel="nofollow" href="http://support.citrix.com/article/CTX116557"   ><span style="color:#1f497d; font-family:Segoe UI; font-size:12pt;"   >http://support.citrix.com/article/CTX116557</span></a><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p><p style="background: white;"   >&nbsp;
&nbsp;</p><p style="background: white;"   ><span style="color:#1f497d; font-family:Segoe UI;"   ><span style="font-size:12pt;"   >Wireshark</span><span style="color:#2a2a2a; font-size:9pt;"   >
</span></span></p><p style="background: white;"   ><a rel="nofollow" href="http://wiki.wireshark.org/SSL"   ><span style="color:#1f497d; font-family:Segoe UI; font-size:12pt;"   >http://wiki.wireshark.org/SSL</span></a><span style="color:#2a2a2a; font-family:Segoe UI; font-size:9pt;"   >
</span></p>
</body></html>