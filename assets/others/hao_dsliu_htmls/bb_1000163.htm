<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：[转]强大的windbg定位内存泄露，两句命令搞定！</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>[转]强大的windbg定位内存泄露，两句命令搞定！</h2>
<p align="right">发布时间：2012-5-15 20:42
<br>分类名称：Debug_Crack</p><br>
<p>转自：http://hi.baidu.com/xingxing/item/f834ffeae93fcf2d5b7cfb9a </p><p>1.简单配置<br>在windbg程序目录下有个gflags.exe，运行后设置：<br><br><img title="[转]强大的windbg定位内存泄露，两句命令搞定！ - Dsliu - Dspace"  src="pic/img6.ph.126.net_Tm8GoLZQeWsmo1ZXCLCoOg==_2582251436361076936.jpg"  alt=""  /><br><br>运行CMD.EXE，输入<strong>"D:\Debugging Tools for Windows (x86)\gflags.exe" /i test.exe +ust</strong>,如果设置成功则显示：<br><img title="[转]强大的windbg定位内存泄露，两句命令搞定！ - Dsliu - Dspace"  src="pic/img4.ph.126.net_GrjVqc_vnTWqhnp_oQkCpA==_2739877423319054024.jpg"  alt=""  /><br><br>如果设置失败，说明注册表被禁用了，可以尝试解除所有对注册表的禁用。这个注册表位置为：<strong>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options</strong>，命令"<strong>gflags.exe /i test.exe +ust</strong>"实际上就是在该路径下创建一个子键"test.exe"并创建一个名为GlobalFlag内容为0x00001000的REG_DWORD值。<br>参考：<a target="_blank" rel="nofollow" href="http://support.citrix.com/article/CTX106970"  >http://support.citrix.com/article/CTX106970</a><br><br>我起初的时候也设置失败了，后来发现是360的一个服务禁止了对上述注册表的操作，卸载之后就行了。<br><br>2.关于符号<br>如果符号不全或者不正确，也不能使用该方法侦测内存泄露的位置。如果真机系统符号不全（如xp sp3），可以在虚拟机中侦测。<br><br>3.具体实例<br>例如内存泄露：<br>Detected memory leaks!<br>Dumping objects -&gt;<br>e:\vs工程\tests\testsdlg.cpp(101) : {118} normal block at <strong>0x003BBAD8</strong>, 100 bytes long.<br>Data: &lt;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; &gt; CD CD CD CD CD CD CD CD CD CD CD CD CD CD CD CD <br>Object dump complete.<br><br>!heap -x 0x003BBAD8<br><br>Entry&nbsp;&nbsp;&nbsp;&nbsp; User&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Heap&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Segment&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Size&nbsp; PrevSize&nbsp; Unused&nbsp;&nbsp;&nbsp; Flags<br>-----------------------------------------------------------------------------<br><strong>003bbab0&nbsp; </strong>003bbab8&nbsp; 003b0000&nbsp; 003b0640&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; a0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 17f0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 18&nbsp; busy extra fill <br><br>!heap -p -a 003bbab0&nbsp; <br><br>address 003bbab0 found in<br>_HEAP @ 3b0000<br>HEAP_ENTRY Size Prev Flags&nbsp;&nbsp;&nbsp; UserPtr UserSize - state<br>003bbab0 0014 0000&nbsp; [07]&nbsp;&nbsp; 003bbab8&nbsp;&nbsp;&nbsp; 00088 - (busy)<br>Trace: 0357<br>7c98eed2 ntdll!RtlDebugAllocateHeap+0x000000e1<br>7c96b394 ntdll!RtlAllocateHeapSlowly+0x00000044<br>7c938f21 ntdll!RtlAllocateHeap+0x00000e64<br>1024db9c MSVCR80D!malloc_base+0x000000ec<br>1020faa5 MSVCR80D!malloc_dbg+0x000002d5<br>1020f839 MSVCR80D!malloc_dbg+0x00000069<br>1020f7ef MSVCR80D!malloc_dbg+0x0000001f<br>78332934 MFC80UD+0x00052934<br>783329b8 MFC80UD+0x000529b8<br>78332396 MFC80UD+0x00052396<br><strong>4129ae tests!CtestsDlg::OnInitDialog+0x0000013e</strong><br>7839bfae MFC80UD+0x000bbfae<br>77d18734 USER32!InternalCallWinProc+0x00000028<br>77d2413c USER32!UserCallDlgProcCheckWow+0x000000f0<br>77d23b30 USER32!DefDlgProcWorker+0x000000a8<br>77d23d5c USER32!DefDlgProcW+0x00000022<br>77d18734 USER32!InternalCallWinProc+0x00000028<br>77d18816 USER32!UserCallWinProcCheckWow+0x00000150<br>77d2a013 USER32!CallWindowProcAorW+0x00000098<br>77d2a039 USER32!CallWindowProcW+0x0000001b<br>7835e302 MFC80UD+0x0007e302<br>7835cb1b MFC80UD+0x0007cb1b<br>7839d393 MFC80UD+0x000bd393<br>7835fbf7 MFC80UD+0x0007fbf7<br>7835f3b0 MFC80UD+0x0007f3b0<br>7835c9be MFC80UD+0x0007c9be<br>7835ceb4 MFC80UD+0x0007ceb4<br>78358979 MFC80UD+0x00078979<br>77d18734 USER32!InternalCallWinProc+0x00000028<br>77d18816 USER32!UserCallWinProcCheckWow+0x00000150<br>77d2927b USER32!SendMessageWorker+0x000004a5<br>77d2651a USER32!InternalCreateDialog+0x000009df<br><br>其中<strong>4129ae </strong>地址就是分配内存的地方，从而导致的内存泄露。</p>
</body></html>