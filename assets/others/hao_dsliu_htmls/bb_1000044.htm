<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：[转] c++避免delete不完整类型 --checked_delete</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>[转] c++避免delete不完整类型 --checked_delete</h2>
<p align="right">发布时间：2014-6-3 12:02
<br>分类名称：默认分类</p><br>
<p style="background: white;"     >
&nbsp;</p><p style="background: white;"     ><span style="color:#333333; font-size:12pt;"     ><span style="font-family:Arial;"     >From</span><span style="font-family:宋体;"     >：</span><span style="font-family:Arial;"     >http://blog.csdn.net/hzyong_c/article/details/7777344
</span></span></p><p style="background: white;"     ><span style="color:#333333; font-size:12pt;"     ><span style="font-family:宋体;"     >在</span><span style="font-family:Arial;"     >C++</span><span style="font-family:宋体;"     >中，</span><span style="font-family:Arial;"     >delete</span><span style="font-family:宋体;"     >一个类型不完整的类对象的指针</span><span style="font-family:Arial;"     >,</span><span style="font-family:宋体;"     >编译器会发出警告，不幸的是，程序员有时候会忽略这种警告。在下面的例子中，</span><span style="font-family:Arial;"     >main</span><span style="font-family:宋体;"     >函数里</span><span style="font-family:Arial;"     >new</span><span style="font-family:宋体;"     >了一个类指针，调用</span><span style="font-family:Arial;"     >delete_obj</span><span style="font-family:宋体;"     >函数</span><span style="font-family:Arial;"     >delete</span><span style="font-family:宋体;"     >企图这个指针</span><span style="font-family:Arial;"     >,delete_obj</span><span style="font-family:宋体;"     >函数定义在</span><span style="font-family:Arial;"     >del.h</span><span style="font-family:宋体;"     >文件中，然而</span><span style="font-family:Arial;"     >delete_obj</span><span style="font-family:宋体;"     >函数只能</span><span style="font-family:Arial;"     >"</span><span style="font-family:宋体;"     >看见</span><span style="font-family:Arial;"     >"Object</span><span style="font-family:宋体;"     >类的声明，不能</span><span style="font-family:Arial;"     >"</span><span style="font-family:宋体;"     >看见</span><span style="font-family:Arial;"     >"</span><span style="font-family:宋体;"     >其定义。运行的结果发现</span><span style="font-family:Arial;"     >Object</span><span style="font-family:宋体;"     >析构没被调用。</span><span style="font-family:Arial;"     >
</span></span></p><ol><li><div style="background: white;"     ><span style="color:#008200; font-family:Consolas; font-size:10pt;"     >//&nbsp;filename&nbsp;:&nbsp;object.h<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     >&nbsp;&nbsp;
&nbsp;</div></li><li><div style="background: white;"     ><span style="color:#006699; font-family:Consolas; font-size:10pt;"     ><strong>class</strong><span style="color:black;"     >&nbsp;Object&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >{&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     ><span style="color:#006699; font-family:Consolas; font-size:10pt;"     ><strong>public</strong><span style="color:black;"     >:&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;Object();&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;~Object();&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >};&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     ><span style="color:#008200; font-family:Consolas; font-size:10pt;"     >//&nbsp;filename&nbsp;:&nbsp;object.cpp<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:gray; font-family:Consolas; font-size:10pt;"     >#include&nbsp;&lt;stdio.h&gt;<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: white;"     ><span style="color:gray; font-family:Consolas; font-size:10pt;"     >#include&nbsp;"object.h"<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     >&nbsp;&nbsp;
&nbsp;</div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >Object::Object()&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >{&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;printf(<span style="color:blue;"     >"%s\n"<span style="color:black;"     >,&nbsp;<span style="color:blue;"     >"A::A()"<span style="color:black;"     >);&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >}&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     >&nbsp;&nbsp;
&nbsp;</div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >Object::~Object()&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >{&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;printf(<span style="color:blue;"     >"%s\n"<span style="color:black;"     >,&nbsp;<span style="color:blue;"     >"A::~A()"<span style="color:black;"     >);&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >}&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     ><span style="color:#008200; font-family:Consolas; font-size:10pt;"     >//&nbsp;filename&nbsp;:&nbsp;del.h<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:#006699; font-family:Consolas; font-size:10pt;"     ><strong>class</strong><span style="color:black;"     >&nbsp;Object;&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: white;"     >&nbsp;&nbsp;
&nbsp;</div></li><li><div style="background: #f8f8f8;"     ><span style="color:#006699; font-family:Consolas; font-size:10pt;"     ><strong>void</strong><span style="color:black;"     >&nbsp;delete_obj(Object*&nbsp;obj)&nbsp;{&nbsp;<span style="color:#006699;"     ><strong>delete</strong><span style="color:black;"     >&nbsp;obj;&nbsp;}&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></div></li><li><div style="background: white;"     ><span style="color:#008200; font-family:Consolas; font-size:10pt;"     >//&nbsp;main.cpp<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:gray; font-family:Consolas; font-size:10pt;"     >#include&nbsp;"del.h"<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: white;"     ><span style="color:gray; font-family:Consolas; font-size:10pt;"     >#include&nbsp;"object.h"<span style="color:black;"     >&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:seagreen; font-family:Consolas; font-size:10pt;"     ><strong>int</strong><span style="color:black;"     >&nbsp;main()&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >{&nbsp;&nbsp;&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;Object&nbsp;*obj&nbsp;=&nbsp;<span style="color:#006699;"     ><strong>new</strong><span style="color:black;"     >&nbsp;Object;&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;delete_obj(obj);&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >}&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li></ol><p><span style="color:#333333;"     ><span style="font-family:Arial; font-size:12pt;"     ><br></span><span style="font-family:宋体;"     ><span style="font-size:16pt; background-color:white;"     >解决方法</span><span style="font-size:12pt; background-color:white;"     >：</span></span></span><span style="font-family:宋体; font-size:16pt;"     >
</span></p><p style="background: white;"     ><span style="color:#333333; font-size:12pt;"     ><span style="font-family:宋体;"     >下面是</span><span style="font-family:Arial;"     >boost::checked_delete</span><span style="font-family:宋体;"     >的实现，在</span><span style="font-family:Arial;"     >Boost Utility</span><span style="font-family:宋体;"     >库中，如果</span><span style="font-family:Arial;"     >T</span><span style="font-family:宋体;"     >只声明了而未定义，</span><span style="font-family:Arial;"     >sizeof(T)</span><span style="font-family:宋体;"     >将返回</span><span style="font-family:Arial;"     >0</span><span style="font-family:宋体;"     >，此时</span><span style="font-family:Arial;"     >checked_delete</span><span style="font-family:宋体;"     >将因为声明</span><span style="font-family:Arial;"     >-1</span><span style="font-family:宋体;"     >个成员的数组而引发错误。</span><span style="font-family:Arial;"     >
</span></span></p><ol><li><div style="background: white;"     ><span style="color:#006699; font-family:Consolas; font-size:10pt;"     ><strong>template</strong><span style="color:black;"     >&lt;<span style="color:#006699;"     ><strong>class</strong><span style="color:black;"     >&nbsp;T&gt;&nbsp;<span style="color:#006699;"     ><strong>inline</strong><span style="color:black;"     >&nbsp;<span style="color:#006699;"     ><strong>void</strong><span style="color:black;"     >&nbsp;checked_delete(T&nbsp;*&nbsp;x)&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >{&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;<span style="color:#006699;"     ><strong>typedef</strong><span style="color:black;"     >&nbsp;<span style="color:seagreen;"     ><strong>char</strong><span style="color:black;"     >&nbsp;type_must_be_complete[&nbsp;<span style="color:#006699;"     ><strong>sizeof</strong><span style="color:black;"     >(T)?&nbsp;1:&nbsp;-1&nbsp;];&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;(<span style="color:#006699;"     ><strong>void</strong><span style="color:black;"     >)&nbsp;<span style="color:#006699;"     ><strong>sizeof</strong><span style="color:black;"     >(type_must_be_complete);&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;<span style="color:#006699;"     ><strong>delete</strong><span style="color:black;"     >&nbsp;x;&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >}&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: white;"     >&nbsp;&nbsp;
&nbsp;</div></li><li><div style="background: #f8f8f8;"     ><span style="color:#006699; font-family:Consolas; font-size:10pt;"     ><strong>template</strong><span style="color:black;"     >&lt;<span style="color:#006699;"     ><strong>class</strong><span style="color:black;"     >&nbsp;T&gt;&nbsp;<span style="color:#006699;"     ><strong>inline</strong><span style="color:black;"     >&nbsp;<span style="color:#006699;"     ><strong>void</strong><span style="color:black;"     >&nbsp;checked_array_delete(T&nbsp;*&nbsp;x)&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></span></span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >{&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;<span style="color:#006699;"     ><strong>typedef</strong><span style="color:black;"     >&nbsp;<span style="color:seagreen;"     ><strong>char</strong><span style="color:black;"     >&nbsp;type_must_be_complete[&nbsp;<span style="color:#006699;"     ><strong>sizeof</strong><span style="color:black;"     >(T)?&nbsp;1:&nbsp;-1&nbsp;];&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;(<span style="color:#006699;"     ><strong>void</strong><span style="color:black;"     >)&nbsp;<span style="color:#006699;"     ><strong>sizeof</strong><span style="color:black;"     >(type_must_be_complete);&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></span></span></div></li><li><div style="background: #f8f8f8;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >&nbsp;&nbsp;<span style="color:#006699;"     ><strong>delete</strong><span style="color:black;"     >&nbsp;[]&nbsp;x;&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></span></span></div></li><li><div style="background: white;"     ><span style="color:black; font-family:Consolas; font-size:10pt;"     >}&nbsp;&nbsp;<span style="color:#5c5c5c;"     >
</span></span></div></li></ol><p><span style="color:#333333; font-size:12pt;"     ><span style="font-family:Arial;"     ><br></span><span style="font-family:宋体; background-color:white;"     >（完）</span></span></p>
</body></html>