<html><head><meta http-equiv="Content-Type" content="text/html; charset=utf8"><title>163 blogs的博客：Vista&Win7 下几个有用的函数</title>
<style type="text/css">
a{color: #000000;text-decoration : none;font-size: 10pt;}
a:hover {color: red;text-decoration : underline;}
.replyBox{padding:4px;border:1px solid #D8D8D8;}
</style></head><body><h2>Vista&Win7 下几个有用的函数</h2>
<p align="right">发布时间：2011-2-11 14:19
<br>分类名称：Private</p><br>
<h1><span style="font-size: 16px; line-height: 25px;"    ><a id="&#21028;&#26029;_vista_&#31995;&#32479;" name="&#21028;&#26029;_vista_&#31995;&#32479;" rel="nofollow"    >判断 Vista 系统</a></span></h1><div><pre>BOOL IsVista<span>(</span><span>)</span> <span>{</span>  OSVERSIONINFO osver<span>;</span>  osver.<span>dwOSVersionInfoSize</span> <span>=</span> <span>sizeof</span><span>(</span> OSVERSIONINFO <span>)</span><span>;</span>  <span>if</span> <span>(</span> <span>::</span><span>GetVersionEx</span><span>(</span> <span>&amp;</span>osver <span>)</span> <span>&amp;&amp;</span>     osver.<span>dwPlatformId</span> <span>==</span> VER_PLATFORM_WIN32_NT <span>&amp;&amp;</span>     <span>(</span>osver.<span>dwMajorVersion</span> <span>&gt;=</span> 6 <span>)</span> <span>)</span>   <span>return</span> TRUE<span>;</span>  <span>return</span> FALSE<span>;</span> <span>}</span></pre></div><h3><a id="&#36827;&#31243;&#26435;&#38480;&#26159;&#21542;&#24050;&#32463;&#34987;&#25552;&#21319;" name="&#36827;&#31243;&#26435;&#38480;&#26159;&#21542;&#24050;&#32463;&#34987;&#25552;&#21319;" rel="nofollow"    >进程权限是否已经被提升</a></h3><div><pre><span>#define TokenElevation TokenUser + 19</span> HRESULT IsElevated<span>(</span>BOOL <span>*</span> pbElevated <span>)</span>  <span>{</span>  <span>//ASSERT( IsVista() );</span>    HRESULT hResult <span>=</span> E_FAIL<span>;</span> <span>// assume an error occured</span>  HANDLE hToken <span>=</span> <span>NULL</span><span>;</span>    <span>if</span> <span>(</span> <span>!</span><span>::</span><span>OpenProcessToken</span><span>(</span>      <span>::</span><span>GetCurrentProcess</span><span>(</span><span>)</span>,      TOKEN_QUERY,      <span>&amp;</span>hToken <span>)</span> <span>)</span>  <span>{</span>   <span>//ASSERT( FALSE );</span>   <span>return</span> hResult<span>;</span>  <span>}</span>    TOKEN_ELEVATION te <span>=</span> <span>{</span> 0 <span>}</span><span>;</span>  DWORD dwReturnLength <span>=</span> <span>0</span><span>;</span>    <span>if</span> <span>(</span> <span>!</span><span>::</span><span>GetTokenInformation</span><span>(</span>     hToken,     <span>(</span>TOKEN_INFORMATION_CLASS<span>)</span><span>(</span>TokenElevation<span>)</span>,     <span>&amp;</span>te,     <span>sizeof</span><span>(</span> te <span>)</span>,     <span>&amp;</span>dwReturnLength <span>)</span> <span>)</span>  <span>{</span>   <span>//ASSERT( FALSE );</span>  <span>}</span>  <span>else</span>  <span>{</span>   <span>//ASSERT( dwReturnLength == sizeof( te ) );</span>     hResult <span>=</span> te.<span>TokenIsElevated</span> <span>?</span> S_OK <span>:</span> S_FALSE<span>;</span>      <span>if</span> <span>(</span> pbElevated<span>)</span>    <span>*</span>pbElevated <span>=</span> <span>(</span>te.<span>TokenIsElevated</span> <span>!</span><span>=</span> 0<span>)</span><span>;</span>  <span>}</span>    <span>::</span><span>CloseHandle</span><span>(</span> hToken <span>)</span><span>;</span>    <span>return</span> hResult<span>;</span> <span>}</span></pre></div><h3><a id="&#20026;&#25353;&#38062;&#21152;&#30462;&#29260;&#22270;&#26631;" name="&#20026;&#25353;&#38062;&#21152;&#30462;&#29260;&#22270;&#26631;" rel="nofollow"    >为按钮加盾牌图标</a></h3><div><pre><span>#define BCM_FIRST  0x1600   //Normal button</span> <span>#define BCM_SETSHIELD (BCM_FIRST + 0x000C)  //Elevated button</span> <span>void</span> AddShieldToButton<span>(</span>HWND hDlgWnd,UINT nID<span>)</span> <span>{</span>  HWND hBtnWnd<span>=</span>GetDlgItem<span>(</span>hDlgWnd,nID<span>)</span><span>;</span>  DWORD dwOldStyle<span>=</span><span>0</span><span>;</span>    dwOldStyle<span>=</span>GetWindowLong<span>(</span>hBtnWnd,GWL_STYLE<span>)</span><span>;</span>  SetWindowLong<span>(</span>hBtnWnd,GWL_STYLE,dwOldStyle<span>|</span>BS_FLAT<span>)</span><span>;</span>    <span>::</span><span>SendMessage</span><span>(</span>hBtnWnd,BCM_SETSHIELD, 0, 1<span>)</span><span>;</span> <span>}</span></pre></div><h3><a id="&#22914;&#20309;&#25552;&#21319;&#36827;&#31243;&#26435;&#38480;" name="&#22914;&#20309;&#25552;&#21319;&#36827;&#31243;&#26435;&#38480;" rel="nofollow"    >如何提升进程权限</a></h3><div><pre><span>//////////////////////////////////////////////////////////////////////////</span> <span>// RunElevated simply calls ShellExecuteEx with the verb "runas" to start the elevated process.</span> <span>// I wish there was a just as easy way to start a non-elevated process, as well.</span> <span>//if user cancel or other errors,return false</span> <span>//else return true</span> BOOL  RunElevated<span>(</span>    HWND hwnd,    LPCTSTR pszPath,    LPCTSTR pszParameters <span>=</span> <span>NULL</span>,    LPCTSTR pszDirectory <span>=</span> <span>NULL</span> <span>)</span> <span>{</span>  SHELLEXECUTEINFO shex<span>;</span>    <span>memset</span><span>(</span> <span>&amp;</span>shex, 0, <span>sizeof</span><span>(</span> shex<span>)</span> <span>)</span><span>;</span>    shex.<span>cbSize</span>   <span>=</span> <span>sizeof</span><span>(</span> SHELLEXECUTEINFO <span>)</span><span>;</span>   shex.<span>fMask</span>   <span>=</span> <span>0</span><span>;</span>   shex.<span>hwnd</span>   <span>=</span> hwnd<span>;</span>  shex.<span>lpVerb</span>   <span>=</span> _T<span>(</span><span>"runas"</span><span>)</span><span>;</span>   shex.<span>lpFile</span>   <span>=</span> pszPath<span>;</span>   shex.<span>lpParameters</span> <span>=</span> pszParameters<span>;</span>   shex.<span>lpDirectory</span> <span>=</span> pszDirectory<span>;</span>   shex.<span>nShow</span>   <span>=</span> SW_NORMAL<span>;</span>     <span>return</span> <span>::</span><span>ShellExecuteEx</span><span>(</span> <span>&amp;</span>shex <span>)</span><span>;</span> <span>}</span></pre></div><wbr>
</body></html>